<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Workshop Sorter</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --lsu-purple:#461D7C; --lsu-gold:#FDD023; --ink:#1f2430; --muted:#6b7280;
  --line:#d1d5db; --line-soft:#e5e7eb; --bg:#fafafa; --card:#ffffff;
  --brand-font: Inter, system-ui, "Segoe UI", Roboto, Arial, sans-serif;
  --radius:14px; --radius-sm:10px; --shadow:0 1px 2px rgba(0,0,0,.04);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--brand-font);line-height:1.4}
.header{background:linear-gradient(90deg,var(--lsu-purple),#2d1252);color:#fff;padding:24px 16px}
.wrap{max-width:1120px;margin:0 auto;padding:16px}
.brand{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.brand .title{font-size:22px;letter-spacing:.2px}
.card{background:var(--card);border:1px solid var(--line-soft);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);margin-bottom:14px}
label.small{font-size:12px;color:var(--muted)}
select,input[type=file],input[type=text],input[type=number]{width:100%;padding:10px;border:1px solid var(--line-soft);border-radius:var(--radius-sm);background:#fff;transition:border-color .15s,box-shadow .15s}
select:focus,input:focus{outline:0;border-color:var(--lsu-purple);box-shadow:0 0 0 3px rgba(70,29,124,.15)}
input.invalid{border-color:#dc2626;background:#fff5f5}
button{font-family:inherit;cursor:pointer;border-radius:12px;font-weight:600}
button.primary{background:var(--lsu-gold);color:#3a2b00;border:0;padding:12px 18px}
button.primary:hover{filter:brightness(.98)}
button.primary:focus{outline:0;box-shadow:0 0 0 3px rgba(253,208,35,.35)}
button.ghost{background:#fff;border:1px solid var(--line-soft);padding:10px 14px}
.smallbtn{padding:8px 10px;border-radius:10px;border:1px solid var(--line-soft);background:#fff}
button[disabled]{opacity:.55;cursor:not-allowed}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.five{display:grid;grid-template-columns:1fr 1fr 130px 120px 36px;gap:10px;align-items:center}
.hidden{display:none}
.badge{font-size:12px;padding:2px 8px;border:1px solid var(--line-soft);border-radius:999px;color:#6b7280}
.note{color:var(--muted);font-size:12px}
.tabs{display:flex;gap:8px;margin:8px 0 0}
.tab{padding:8px 12px;border:1px solid var(--line-soft);border-bottom:0;border-radius:10px 10px 0 0;background:#f8fafc;cursor:pointer}
.tab.active{background:#fff;border-color:var(--lsu-purple)}
.panel{border:1px solid var(--line-soft);border-radius:0 12px 12px 12px;background:#fff;padding:12px}
.dropzone{display:flex;align-items:center;justify-content:center;border:2px dashed var(--line);border-radius:12px;min-height:44px;color:#6b7280;background:#fff;user-select:none}
.dropzone.drag{border-color:var(--lsu-purple);background:#faf5ff}
.dropzone.disabled{opacity:.6;pointer-events:none}
.scrollbox{max-height:420px;overflow:auto;border:1px solid var(--line);border-radius:12px;background:#fff}
table{width:100%}
table.report{border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.02)}
.report thead th{background:#f8fafc;font-weight:600;position:sticky;top:0;z-index:1}
.report th,.report td{padding:10px 12px;text-align:left;vertical-align:top;border-right:1px solid var(--line-soft);border-bottom:1px solid var(--line-soft)}
.report th:last-child,.report td:last-child{border-right:0}.report tr:last-child td{border-bottom:0}
#balanceTable th:nth-child(3),#balanceTable td:nth-child(3),#balanceTable th:nth-child(4),#balanceTable td:nth-child(4){text-align:right;font-variant-numeric:tabular-nums}
#balanceTable th:nth-child(5),#balanceTable td:nth-child(5){white-space:nowrap}
.row-issue td{background:#FFF7ED}
.issues{display:flex;flex-wrap:wrap;gap:6px}
.issue-pill{font-size:11px;padding:2px 8px;border-radius:999px;background:#FEF3C7;border:1px solid#FDE68A;color:#92400E}
.issue-legend{color:#6b7280;font-size:12px;margin-top:6px}
#rosterDoc{display:flex;flex-direction:column;gap:12px}
.roster-section{border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.02);overflow:hidden}
.roster-header{background:#f3f4f6;font-weight:800;text-align:center;font-size:16px;padding:10px 12px}
.roster-header .ws-name{font-weight:900}.roster-header .instructor{font-weight:800}.roster-header .room{color:#374151}.roster-header .count{font-weight:800;white-space:nowrap}
.name-grid{padding:8px 10px 12px 10px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:6px 24px}
@media (max-width:900px){.name-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:560px){.name-grid{grid-template-columns:1fr}}
.name{padding:2px 0;border-bottom:1px solid var(--line-soft);whitespace:nowrap;overflow:hidden;text-overflow:ellipsis}
.name:last-child{border-bottom:0}
.nojs{background:#fff3cd;color:#3b2a00;border:1px solid #ffe69c;padding:10px;border-radius:10px;margin:12px 0}
.locknote{color:var(--muted);font-size:12px}
@media print{.header,.tabs,.printbar,.badge{display:none !important}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
</head>
<body>
<noscript><div class="wrap"><div class="nojs">JavaScript is disabled. Turn it on to use Workshop Sorter.</div></div></noscript>

<div class="header"><div class="wrap brand"><div class="title">Workshop Sorter</div></div></div>

<div class="wrap" id="appRoot" aria-busy="true">
  <!-- STEP 1 -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div><div class="badge">step 1 of 3</div><div style="margin-top:6px">Define workshops before loading students</div></div>
      <div class="two" style="align-items:end;min-width:360px">
        <div><label class="small">How many workshops (1–20)</label><select id="numWorkshops"><option value="0">Select count</option></select></div>
        <button id="buildWorkshopRows" class="ghost">Create rows</button>
      </div>
    </div>
    <div class="two" style="margin-top:10px">
      <div><label class="small">Upload Workshops CSV (Instructor, Workshop, [Room], [Capacity])</label><input id="workshopCsvFile" type="file" accept=".csv"></div>
      <div id="workshopDrop" class="dropzone" tabindex="0" role="button" aria-label="Drop workshops CSV here or click to browse">Drag and drop Workshops CSV here</div>
    </div>
    <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap">
      <button id="importWorkshopsBtn" class="ghost">Import workshops</button>
      <button id="addWorkshopRow" class="smallbtn" title="Add a new row">Add workshop</button>
      <button id="undoDelete" class="smallbtn" title="Undo last delete" disabled>Undo delete</button>
      <button id="clearWorkshops" class="smallbtn">Clear all</button>
    </div>
    <fieldset id="wkFieldset" style="margin-top:10px;border:0;padding:0"><div id="wkContainer"></div></fieldset>
    <div id="wkErrors" class="helper hidden"></div>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <div class="locknote hidden" id="lockNote">Workshops are locked. Click Reset all in Step 3 to start over.</div>
      <button id="lockWorkshops" class="primary">Lock workshops and continue</button>
    </div>
    <div class="note" style="margin-top:6px">Capacity and Room import from CSV if present. Capacity defaults to 12 if blank.</div>
  </div>

  <!-- STEP 2 -->
  <div class="card">
    <div class="badge">step 2 of 3</div>
    <div style="margin-top:6px">Load students with three ranked choices</div>
    <div class="two">
      <div>
        <label class="small">Upload CSV with columns: Last, First, School, Choice1, Choice2, Choice3
          <br>(Also supports legacy "Student, Choice1, Choice2, Choice3")</label>
        <input id="csvFile" type="file" accept=".csv" disabled>
      </div>
      <div id="studentDrop" class="dropzone disabled" tabindex="0" role="button" aria-label="Drop students CSV here or click to browse">Drag and drop Student CSV here</div>
    </div>

    <div id="studentsPreview" class="hidden" style="margin-top:10px">
      <div class="badge">loaded students</div>
      <div class="scrollbox">
        <table id="studentsTable" class="report">
          <thead><tr>
            <th>Last Name</th><th>First Name</th><th>School</th>
            <th>First Choice</th><th>Second Choice</th><th>Third Choice</th><th>Issues</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="issueLegend" class="issue-legend hidden">
        Issues show the reason a student is flagged. Examples: Missing one or more choices, Duplicate choices, Unknown workshop name.
      </div>
      <div class="printbar" style="margin-top:8px">
        <button id="printStudents" class="ghost">Export students (PDF)</button>
        <button id="exportStudentsCsv" class="ghost">Export students (.csv)</button>
      </div>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="card">
    <div class="badge">step 3 of 3</div>
    <div style="margin-top:6px">Run assignment and review the report</div>
    <div class="row" style="gap:12px">
      <button id="runBtn" class="primary" disabled>Run assignment</button>
      <button id="resetAll" class="ghost">Reset all</button>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="resultsCard" class="card hidden">
    <div class="tabs">
      <div id="tabSummary" class="tab active">Summary</div>
      <div id="tabStudents" class="tab">Student assignments</div>
      <div id="tabRosters" class="tab">Workshop rosters</div>
      <div id="tabUnplaced" class="tab">Unplaced students</div>
    </div>
    <div class="panel">
      <div id="panelSummary">
        <div class="kv" style="display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:8px">
          <div>Total students: <span id="kvStudents"></span></div>
          <div>Total workshops: <span id="kvWorkshops"></span></div>
          <div>Total capacity: <span id="kvCapacity"></span></div>
          <div>Unplaced: <span id="kvUnplaced"></span></div>
        </div>
        <table id="balanceTable" class="report">
          <colgroup><col style="width:28%"><col style="width:34%"><col style="width:12%"><col style="width:12%"><col style="width:14%"></colgroup>
          <thead><tr><th>Instructor</th><th>Workshop</th><th>Capacity</th><th>Assigned</th><th>Room</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="printbar">
          <button id="printSummary" class="ghost">Export summary (PDF)</button>
          <button id="exportSummaryCsv" class="ghost">Export summary (.csv)</button>
        </div>
      </div>

      <div id="panelStudents" class="hidden">
        <div class="scrollbox">
          <table id="studentTable" class="report">
            <thead><tr><th>Last Name</th><th>First Name</th><th>School</th><th>Assigned workshop</th><th>Room</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="printbar">
          <button id="printAssignments" class="ghost">Export assignments (PDF)</button>
          <button id="exportAssignmentsCsv" class="ghost">Export assignments (.csv)</button>
        </div>
      </div>

      <div id="panelRosters" class="hidden">
        <div class="scrollbox"><div id="rosterDoc"></div></div>
        <div class="printbar">
          <button id="printRosters" class="ghost">Export rosters (PDF)</button>
          <button id="exportRostersCsv" class="ghost">Export rosters (.csv)</button>
        </div>
      </div>

      <div id="panelUnplaced" class="hidden">
        <div class="scrollbox">
          <table id="unplacedTable" class="report">
            <thead><tr><th>Last Name</th><th>First Name</th><th>School</th><th>Preference</th><th>Reason</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="printbar">
          <button id="printUnplaced" class="ghost">Export unplaced (PDF)</button>
          <button id="exportUnplacedCsv" class="ghost">Export unplaced (.csv)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function showInitError(msg){
  try{
    const root=document.getElementById('appRoot'); if(!root) return;
    const d=document.createElement('div'); d.className='nojs';
    d.textContent='There was an error initializing the app: ' + (msg||'unknown error');
    root.prepend(d);
  }catch(_){}
}

try{
  ['dragenter','dragover','drop'].forEach(evt=>{
    document.addEventListener(evt, e=>{
      if (e.target && e.target.closest && e.target.closest('.dropzone')) return;
      e.preventDefault();
    }, false);
  });

  // ============ UTILITY FUNCTIONS ============
  
  // Normalize text for comparison - handles apostrophes and special characters
  function normalizeText(str) {
    if (!str) return '';
    return str
      .trim()
      // Replace various apostrophe types with standard apostrophe
      .replace(/[\u2019\u2018\u00B4\u0060\u02BC\uFF07]/g, "'")
      // Replace special question marks
      .replace(/[\uFF1F]/g, "?")
      // Normalize whitespace
      .replace(/\s+/g, ' ')
      // Convert to lowercase for case-insensitive comparison
      .toLowerCase();
  }

  // Find workshop by normalized name
  function findWorkshopByName(name, workshopList) {
    const normalized = normalizeText(name);
    return workshopList.find(w => normalizeText(w.name) === normalized);
  }

  // Check if workshop name exists in list
  function workshopExists(name, workshopList) {
    return !!findWorkshopByName(name, workshopList);
  }

  function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (!lines.length) return [];
    const rows = [];
    for (let line of lines) {
      const row = [];
      let inQuote = false, cell = '';
      for (let i = 0; i < line.length; i++) {
        const c = line[i], next = line[i + 1];
        if (c === '"') {
          if (inQuote && next === '"') { cell += '"'; i++; }
          else inQuote = !inQuote;
        } else if (c === ',' && !inQuote) {
          row.push(cell.trim()); cell = '';
        } else {
          cell += c;
        }
      }
      row.push(cell.trim());
      rows.push(row);
    }
    return rows;
  }

  function escHTML(s) {
    const div = document.createElement('div');
    div.textContent = s || '';
    return div.innerHTML;
  }

  function $(id) { return document.getElementById(id); }

  // ============ STATE ============
  let workshops = [];
  let students = [];
  let assignments = [];
  let deletedWorkshops = [];
  let workshopsLocked = false;

  // ============ WORKSHOP MANAGEMENT ============
  const numWorkshopsEl = $('numWorkshops');
  for (let i = 1; i <= 20; i++) {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = i;
    numWorkshopsEl.appendChild(opt);
  }

  $('buildWorkshopRows').onclick = () => {
    if (workshopsLocked) return;
    const n = parseInt(numWorkshopsEl.value, 10);
    if (!n || n < 1 || n > 20) return alert('Select a valid number between 1 and 20');
    workshops = Array.from({ length: n }, () => ({ instructor: '', name: '', capacity: 12, room: '' }));
    renderWorkshops();
  };

  $('addWorkshopRow').onclick = () => {
    if (workshopsLocked) return;
    workshops.push({ instructor: '', name: '', capacity: 12, room: '' });
    renderWorkshops();
  };

  $('clearWorkshops').onclick = () => {
    if (workshopsLocked) return;
    if (!confirm('Clear all workshops?')) return;
    workshops = [];
    deletedWorkshops = [];
    renderWorkshops();
  };

  $('undoDelete').onclick = () => {
    if (workshopsLocked || !deletedWorkshops.length) return;
    const last = deletedWorkshops.pop();
    workshops.splice(last.index, 0, last.workshop);
    renderWorkshops();
  };

  function renderWorkshops() {
    const container = $('wkContainer');
    container.innerHTML = '';
    if (!workshops.length) {
      container.innerHTML = '<div class="note">No workshops defined yet. Set a count above or import a CSV.</div>';
      $('undoDelete').disabled = true;
      return;
    }
    workshops.forEach((w, i) => {
      const row = document.createElement('div');
      row.className = 'five';
      row.style.marginBottom = '8px';
      row.innerHTML = `
        <input type="text" placeholder="Instructor" value="${escHTML(w.instructor)}" data-idx="${i}" data-field="instructor" ${workshopsLocked ? 'disabled' : ''}>
        <input type="text" placeholder="Workshop name" value="${escHTML(w.name)}" data-idx="${i}" data-field="name" ${workshopsLocked ? 'disabled' : ''}>
        <input type="number" placeholder="Capacity" value="${w.capacity}" data-idx="${i}" data-field="capacity" min="1" ${workshopsLocked ? 'disabled' : ''}>
        <input type="text" placeholder="Room" value="${escHTML(w.room)}" data-idx="${i}" data-field="room" ${workshopsLocked ? 'disabled' : ''}>
        <button class="smallbtn" data-delete="${i}" title="Delete" ${workshopsLocked ? 'disabled' : ''}>✕</button>
      `;
      container.appendChild(row);
    });
    container.querySelectorAll('input').forEach(inp => {
      inp.oninput = e => {
        const idx = parseInt(e.target.dataset.idx, 10);
        const field = e.target.dataset.field;
        if (field === 'capacity') {
          workshops[idx][field] = parseInt(e.target.value, 10) || 12;
        } else {
          workshops[idx][field] = e.target.value;
        }
      };
    });
    container.querySelectorAll('[data-delete]').forEach(btn => {
      btn.onclick = () => {
        const idx = parseInt(btn.dataset.delete, 10);
        deletedWorkshops.push({ index: idx, workshop: workshops[idx] });
        workshops.splice(idx, 1);
        renderWorkshops();
      };
    });
    $('undoDelete').disabled = deletedWorkshops.length === 0 || workshopsLocked;
  }

  // ============ WORKSHOP CSV IMPORT ============
  const workshopCsvFile = $('workshopCsvFile');
  const workshopDrop = $('workshopDrop');

  function handleWorkshopFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      try {
        const rows = parseCSV(evt.target.result);
        if (rows.length < 2) return alert('Workshop CSV must have at least a header and one row');
        const data = rows.slice(1).map(r => ({
          instructor: r[1] || '',
          name: r[0] || '',
          room: r[2] || '',
          capacity: parseInt(r[3], 10) || 12
        })).filter(w => w.name.trim());
        if (!data.length) return alert('No valid workshops found in CSV');
        workshops = data;
        deletedWorkshops = [];
        renderWorkshops();
      } catch (err) {
        alert('Error parsing workshop CSV: ' + err.message);
      }
    };
    reader.readAsText(file);
  }

  workshopCsvFile.onchange = e => {
    if (workshopsLocked) return;
    handleWorkshopFile(e.target.files[0]);
  };

  workshopDrop.onclick = () => {
    if (workshopsLocked) return;
    workshopCsvFile.click();
  };

  workshopDrop.ondragenter = workshopDrop.ondragover = e => {
    if (workshopsLocked) return;
    e.preventDefault();
    workshopDrop.classList.add('drag');
  };

  workshopDrop.ondragleave = e => {
    if (e.target === workshopDrop) workshopDrop.classList.remove('drag');
  };

  workshopDrop.ondrop = e => {
    if (workshopsLocked) return;
    e.preventDefault();
    workshopDrop.classList.remove('drag');
    const file = e.dataTransfer?.files[0];
    if (file) handleWorkshopFile(file);
  };

  $('importWorkshopsBtn').onclick = () => {
    if (workshopsLocked) return;
    workshopCsvFile.click();
  };

  // ============ LOCK WORKSHOPS ============
  $('lockWorkshops').onclick = () => {
    const missing = workshops.filter(w => !w.name.trim() || !w.instructor.trim());
    if (missing.length) return alert('All workshops must have a name and instructor before locking');
    workshopsLocked = true;
    $('lockNote').classList.remove('hidden');
    $('lockWorkshops').disabled = true;
    $('csvFile').disabled = false;
    $('studentDrop').classList.remove('disabled');
    $('wkFieldset').disabled = true;
    $('numWorkshops').disabled = true;
    $('buildWorkshopRows').disabled = true;
    $('addWorkshopRow').disabled = true;
    $('clearWorkshops').disabled = true;
    $('undoDelete').disabled = true;
    $('workshopCsvFile').disabled = true;
    $('importWorkshopsBtn').disabled = true;
    renderWorkshops();
  };

  // ============ STUDENT CSV IMPORT ============
  const csvFile = $('csvFile');
  const studentDrop = $('studentDrop');

  function handleStudentFile(file) {
    if (!file || !workshopsLocked) return;
    const reader = new FileReader();
    reader.onload = evt => {
      try {
        const rows = parseCSV(evt.target.result);
        if (rows.length < 2) return alert('Student CSV must have at least a header and one row');
        const header = rows[0].map(h => h.toLowerCase().trim());
        const hasLast = header.includes('last name') || header.includes('last');
        const hasFirst = header.includes('first name') || header.includes('first');
        const hasSchool = header.includes('school') || header.some(h => h.includes('school'));
        
        let parsed = [];
        if (hasLast && hasFirst) {
          const lastIdx = header.findIndex(h => h === 'last name' || h === 'last');
          const firstIdx = header.findIndex(h => h === 'first name' || h === 'first');
          const schoolIdx = header.findIndex(h => h === 'school' || h.includes('school'));
          const c1Idx = header.findIndex(h => h.includes('choice') || h.includes('academic workshop'));
          const c2Idx = header.findIndex((h, i) => i > c1Idx && (h.includes('choice') || h.includes('academic workshop')));
          const c3Idx = header.findIndex((h, i) => i > c2Idx && (h.includes('choice') || h.includes('academic workshop')));
          
          parsed = rows.slice(1).map(r => ({
            lastName: r[lastIdx] || '',
            firstName: r[firstIdx] || '',
            school: schoolIdx >= 0 ? r[schoolIdx] || '' : '',
            choice1: r[c1Idx] || '',
            choice2: r[c2Idx] || '',
            choice3: r[c3Idx] || ''
          }));
        } else {
          parsed = rows.slice(1).map(r => ({
            lastName: '',
            firstName: r[0] || '',
            school: '',
            choice1: r[1] || '',
            choice2: r[2] || '',
            choice3: r[3] || ''
          }));
        }
        
        students = parsed.filter(s => s.firstName.trim() || s.lastName.trim());
        if (!students.length) return alert('No valid students found in CSV');
        
        renderStudentsPreview();
        $('runBtn').disabled = false;
      } catch (err) {
        alert('Error parsing student CSV: ' + err.message);
      }
    };
    reader.readAsText(file);
  }

  csvFile.onchange = e => handleStudentFile(e.target.files[0]);
  studentDrop.onclick = () => {
    if (!workshopsLocked) return;
    csvFile.click();
  };

  studentDrop.ondragenter = studentDrop.ondragover = e => {
    if (!workshopsLocked) return;
    e.preventDefault();
    studentDrop.classList.add('drag');
  };

  studentDrop.ondragleave = e => {
    if (e.target === studentDrop) studentDrop.classList.remove('drag');
  };

  studentDrop.ondrop = e => {
    if (!workshopsLocked) return;
    e.preventDefault();
    studentDrop.classList.remove('drag');
    const file = e.dataTransfer?.files[0];
    if (file) handleStudentFile(file);
  };

  function renderStudentsPreview() {
    const tbody = $('studentsTable').querySelector('tbody');
    tbody.innerHTML = '';
    let hasIssues = false;
    
    students.forEach(s => {
      const issues = [];
      const choices = [s.choice1, s.choice2, s.choice3].filter(c => c.trim());
      
      if (choices.length < 3) issues.push('Missing choice(s)');
      
      const uniqueChoices = new Set(choices.map(c => normalizeText(c)));
      if (uniqueChoices.size !== choices.length) issues.push('Duplicate choices');
      
      choices.forEach(c => {
        if (!workshopExists(c, workshops)) {
          issues.push(`Unknown: "${c}"`);
        }
      });
      
      const hasIssue = issues.length > 0;
      if (hasIssue) hasIssues = true;
      
      const tr = document.createElement('tr');
      if (hasIssue) tr.className = 'row-issue';
      tr.innerHTML = `
        <td>${escHTML(s.lastName)}</td>
        <td>${escHTML(s.firstName)}</td>
        <td>${escHTML(s.school)}</td>
        <td>${escHTML(s.choice1)}</td>
        <td>${escHTML(s.choice2)}</td>
        <td>${escHTML(s.choice3)}</td>
        <td><div class="issues">${issues.map(iss => `<span class="issue-pill">${escHTML(iss)}</span>`).join('')}</div></td>
      `;
      tbody.appendChild(tr);
    });
    
    $('studentsPreview').classList.remove('hidden');
    if (hasIssues) {
      $('issueLegend').classList.remove('hidden');
    } else {
      $('issueLegend').classList.add('hidden');
    }
  }

  // ============ ASSIGNMENT ALGORITHM ============
  $('runBtn').onclick = () => {
    if (!workshopsLocked || !students.length) return;
    
    const wsMap = new Map();
    workshops.forEach((w, i) => {
      wsMap.set(normalizeText(w.name), {
        ...w,
        index: i,
        assigned: [],
        slots: w.capacity
      });
    });
    
    assignments = [];
    const unplaced = [];
    
    students.forEach(s => {
      let placed = false;
      for (let choice of [s.choice1, s.choice2, s.choice3]) {
        if (!choice.trim()) continue;
        const ws = wsMap.get(normalizeText(choice));
        if (ws && ws.assigned.length < ws.slots) {
          ws.assigned.push(s);
          assignments.push({
            student: s,
            workshop: ws,
            choiceLevel: choice === s.choice1 ? 1 : choice === s.choice2 ? 2 : 3
          });
          placed = true;
          break;
        }
      }
      if (!placed) {
        const prefs = [s.choice1, s.choice2, s.choice3].filter(c => c.trim()).join(', ') || 'None';
        const reasons = [];
        [s.choice1, s.choice2, s.choice3].forEach(c => {
          if (!c.trim()) return;
          const ws = wsMap.get(normalizeText(c));
          if (!ws) reasons.push(`"${c}" not found`);
          else if (ws.assigned.length >= ws.slots) reasons.push(`"${c}" full`);
        });
        unplaced.push({
          student: s,
          preferences: prefs,
          reason: reasons.join('; ') || 'No valid choices'
        });
      }
    });
    
    renderResults(wsMap, unplaced);
  };

  // ============ RESULTS RENDERING ============
  function renderResults(wsMap, unplaced) {
    $('resultsCard').classList.remove('hidden');
    
    $('kvStudents').textContent = students.length;
    $('kvWorkshops').textContent = workshops.length;
    $('kvCapacity').textContent = workshops.reduce((sum, w) => sum + w.capacity, 0);
    $('kvUnplaced').textContent = unplaced.length;
    
    const balanceBody = $('balanceTable').querySelector('tbody');
    balanceBody.innerHTML = '';
    workshops.forEach(w => {
      const ws = wsMap.get(normalizeText(w.name));
      const assigned = ws ? ws.assigned.length : 0;
      const tr = document.createElement('tr');
      if (assigned > w.capacity) tr.className = 'row-issue';
      tr.innerHTML = `
        <td>${escHTML(w.instructor)}</td>
        <td>${escHTML(w.name)}</td>
        <td>${w.capacity}</td>
        <td>${assigned}</td>
        <td>${escHTML(w.room)}</td>
      `;
      balanceBody.appendChild(tr);
    });
    
    const studentBody = $('studentTable').querySelector('tbody');
    studentBody.innerHTML = '';
    assignments.sort((a, b) => {
      const cmp = a.student.lastName.localeCompare(b.student.lastName);
      return cmp !== 0 ? cmp : a.student.firstName.localeCompare(b.student.firstName);
    }).forEach(a => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escHTML(a.student.lastName)}</td>
        <td>${escHTML(a.student.firstName)}</td>
        <td>${escHTML(a.student.school)}</td>
        <td>${escHTML(a.workshop.name)}</td>
        <td>${escHTML(a.workshop.room)}</td>
      `;
      studentBody.appendChild(tr);
    });
    
    const rosterDoc = $('rosterDoc');
    rosterDoc.innerHTML = '';
    workshops.forEach(w => {
      const ws = wsMap.get(normalizeText(w.name));
      const assigned = ws ? ws.assigned : [];
      const section = document.createElement('div');
      section.className = 'roster-section';
      const sorted = assigned.slice().sort((a, b) => {
        const cmp = a.lastName.localeCompare(b.lastName);
        return cmp !== 0 ? cmp : a.firstName.localeCompare(b.firstName);
      });
      section.innerHTML = `
        <div class="roster-header">
          <div class="ws-name">${escHTML(w.name)}</div>
          <div class="instructor">${escHTML(w.instructor)}</div>
          <div class="room">${escHTML(w.room)}</div>
          <div class="count">${assigned.length} / ${w.capacity}</div>
        </div>
        <div class="name-grid">
          ${sorted.map(s => `<div class="name">${escHTML(s.lastName)}, ${escHTML(s.firstName)}</div>`).join('')}
        </div>
      `;
      rosterDoc.appendChild(section);
    });
    
    const unplacedBody = $('unplacedTable').querySelector('tbody');
    unplacedBody.innerHTML = '';
    unplaced.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escHTML(u.student.lastName)}</td>
        <td>${escHTML(u.student.firstName)}</td>
        <td>${escHTML(u.student.school)}</td>
        <td>${escHTML(u.preferences)}</td>
        <td>${escHTML(u.reason)}</td>
      `;
      unplacedBody.appendChild(tr);
    });
  }

  // ============ TABS ============
  const tabs = ['Summary', 'Students', 'Rosters', 'Unplaced'];
  tabs.forEach(t => {
    $('tab' + t).onclick = () => {
      tabs.forEach(t2 => {
        $('tab' + t2).classList.toggle('active', t === t2);
        $('panel' + t2).classList.toggle('hidden', t !== t2);
      });
    };
  });

  // ============ PDF EXPORT ============
  function exportPDF(elementId, filename) {
    const el = $(elementId);
    if (!el) return;
    const opt = {
      margin: 10,
      filename: filename + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    if (window.html2pdf) {
      window.html2pdf().set(opt).from(el).save();
    } else {
      alert('PDF library not loaded');
    }
  }

  $('printSummary').onclick = () => exportPDF('balanceTable', 'workshop-summary');
  $('printAssignments').onclick = () => exportPDF('studentTable', 'student-assignments');
  $('printRosters').onclick = () => exportPDF('rosterDoc', 'workshop-rosters');
  $('printUnplaced').onclick = () => exportPDF('unplacedTable', 'unplaced-students');
  $('printStudents').onclick = () => exportPDF('studentsTable', 'students-preview');

  // ============ CSV EXPORT ============
  function downloadCSV(data, filename) {
    const csv = data.map(row =>
      row.map(cell => {
        const s = String(cell || '');
        return s.includes(',') || s.includes('"') || s.includes('\n')
          ? '"' + s.replace(/"/g, '""') + '"'
          : s;
      }).join(',')
    ).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename + '.csv';
    link.click();
  }

  $('exportSummaryCsv').onclick = () => {
    const data = [['Instructor', 'Workshop', 'Capacity', 'Assigned', 'Room']];
    workshops.forEach(w => {
      const wsNorm = normalizeText(w.name);
      const wsData = Array.from(document.querySelectorAll('#balanceTable tbody tr')).find(tr => {
        const cells = tr.querySelectorAll('td');
        return normalizeText(cells[1].textContent) === wsNorm;
      });
      const assigned = wsData ? wsData.querySelectorAll('td')[3].textContent : '0';
      data.push([w.instructor, w.name, w.capacity, assigned, w.room]);
    });
    downloadCSV(data, 'workshop-summary');
  };

  $('exportAssignmentsCsv').onclick = () => {
    const data = [['Last Name', 'First Name', 'School', 'Assigned Workshop', 'Room']];
    assignments.forEach(a => {
      data.push([a.student.lastName, a.student.firstName, a.student.school, a.workshop.name, a.workshop.room]);
    });
    downloadCSV(data, 'student-assignments');
  };

  $('exportRostersCsv').onclick = () => {
    const data = [['Workshop', 'Instructor', 'Room', 'Capacity', 'Last Name', 'First Name']];
    workshops.forEach(w => {
      const wsNorm = normalizeText(w.name);
      const assigned = assignments.filter(a => normalizeText(a.workshop.name) === wsNorm);
      assigned.sort((a, b) => {
        const cmp = a.student.lastName.localeCompare(b.student.lastName);
        return cmp !== 0 ? cmp : a.student.firstName.localeCompare(b.student.firstName);
      });
      assigned.forEach(a => {
        data.push([w.name, w.instructor, w.room, w.capacity, a.student.lastName, a.student.firstName]);
      });
    });
    downloadCSV(data, 'workshop-rosters');
  };

  $('exportUnplacedCsv').onclick = () => {
    const data = [['Last Name', 'First Name', 'School', 'Preferences', 'Reason']];
    document.querySelectorAll('#unplacedTable tbody tr').forEach(tr => {
      const cells = tr.querySelectorAll('td');
      data.push([cells[0].textContent, cells[1].textContent, cells[2].textContent, cells[3].textContent, cells[4].textContent]);
    });
    downloadCSV(data, 'unplaced-students');
  };

  $('exportStudentsCsv').onclick = () => {
    const data = [['Last Name', 'First Name', 'School', 'First Choice', 'Second Choice', 'Third Choice', 'Issues']];
    students.forEach(s => {
      const issues = [];
      const choices = [s.choice1, s.choice2, s.choice3].filter(c => c.trim());
      if (choices.length < 3) issues.push('Missing choice(s)');
      const uniqueChoices = new Set(choices.map(c => normalizeText(c)));
      if (uniqueChoices.size !== choices.length) issues.push('Duplicate choices');
      choices.forEach(c => {
        if (!workshopExists(c, workshops)) issues.push(`Unknown: "${c}"`);
      });
      data.push([s.lastName, s.firstName, s.school, s.choice1, s.choice2, s.choice3, issues.join('; ')]);
    });
    downloadCSV(data, 'students-preview');
  };

  // ============ RESET ============
  $('resetAll').onclick = () => {
    if (!confirm('Reset everything and start over?')) return;
    workshops = [];
    students = [];
    assignments = [];
    deletedWorkshops = [];
    workshopsLocked = false;
    $('lockNote').classList.add('hidden');
    $('lockWorkshops').disabled = false;
    $('csvFile').disabled = true;
    $('studentDrop').classList.add('disabled');
    $('wkFieldset').disabled = false;
    $('numWorkshops').disabled = false;
    $('buildWorkshopRows').disabled = false;
    $('addWorkshopRow').disabled = false;
    $('clearWorkshops').disabled = false;
    $('workshopCsvFile').disabled = false;
    $('importWorkshopsBtn').disabled = false;
    $('runBtn').disabled = true;
    $('studentsPreview').classList.add('hidden');
    $('resultsCard').classList.add('hidden');
    renderWorkshops();
  };

} catch(err) {
  showInitError(err.message);
  console.error('Init error:', err);
}
</script>
</body>
</html>
