<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Workshop Sorter</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --lsu-purple:#461D7C; --lsu-gold:#FDD023; --ink:#1f2430; --muted:#6b7280;
  --line:#d1d5db; --line-soft:#e5e7eb; --bg:#fafafa; --card:#ffffff;
  --brand-font: Inter, system-ui, "Segoe UI", Roboto, Arial, sans-serif;
  --radius:14px; --radius-sm:10px; --shadow:0 1px 2px rgba(0,0,0,.04);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--brand-font);line-height:1.4}
.header{background:linear-gradient(90deg,var(--lsu-purple),#2d1252);color:#fff;padding:24px 16px}
.wrap{max-width:1120px;margin:0 auto;padding:16px}
.brand{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.brand .title{font-size:22px;letter-spacing:.2px}
.card{background:var(--card);border:1px solid var(--line-soft);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);margin-bottom:14px}
label.small{font-size:12px;color:var(--muted)}
select,input[type=file],input[type=text],input[type=number]{width:100%;padding:10px;border:1px solid var(--line-soft);border-radius:var(--radius-sm);background:#fff;transition:border-color .15s,box-shadow .15s}
select:focus,input:focus{outline:0;border-color:var(--lsu-purple);box-shadow:0 0 0 3px rgba(70,29,124,.15)}
input.invalid{border-color:#dc2626;background:#fff5f5}
button{font-family:inherit;cursor:pointer;border-radius:12px;font-weight:600}
button.primary{background:var(--lsu-gold);color:#3a2b00;border:0;padding:12px 18px}
button.primary:hover{filter:brightness(.98)}
button.primary:focus{outline:0;box-shadow:0 0 0 3px rgba(253,208,35,.35)}
button.ghost{background:#fff;border:1px solid var(--line-soft);padding:10px 14px}
.smallbtn{padding:8px 10px;border-radius:10px;border:1px solid var(--line-soft);background:#fff}
button[disabled]{opacity:.55;cursor:not-allowed}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.five{display:grid;grid-template-columns:1fr 1fr 130px 120px 36px;gap:10px;align-items:center}
.hidden{display:none}
.badge{font-size:12px;padding:2px 8px;border:1px solid var(--line-soft);border-radius:999px;color:#6b7280}
.note{color:var(--muted);font-size:12px}
.tabs{display:flex;gap:8px;margin:8px 0 0}
.tab{padding:8px 12px;border:1px solid var(--line-soft);border-bottom:0;border-radius:10px 10px 0 0;background:#f8fafc;cursor:pointer}
.tab.active{background:#fff;border-color:var(--lsu-purple);color:#lsu-purple}
.panel{border:1px solid var(--line-soft);border-radius:0 12px 12px 12px;background:#fff;padding:12px}
/* drop zones */
.dropzone{display:flex;align-items:center;justify-content:center;border:2px dashed var(--line);border-radius:12px;min-height:44px;color:#6b7280;background:#fff; user-select:none}
.dropzone.drag{border-color:var(--lsu-purple);background:#faf5ff}
.dropzone.disabled{opacity:.6;pointer-events:none}
/* generic scrollbox */
.scrollbox{
  max-height:420px;
  overflow:auto;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
}
/* tables */
table{width:100%}
table.report{
  border-collapse:separate;border-spacing:0;border:1px solid var(--line);
  border-radius:12px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.02);
}
.report thead th{
  background:#f8fafc;font-weight:600;
  position:sticky; top:0; z-index:1;
}
.report th,.report td{
  padding:10px 12px;text-align:left;vertical-align:top;
  border-right:1px solid var(--line-soft);border-bottom:1px solid var(--line-soft);
}
.report th:last-child,.report td:last-child{border-right:0}
.report tr:last-child td{border-bottom:0}
/* Summary align */
#balanceTable th:nth-child(3),#balanceTable td:nth-child(3),
#balanceTable th:nth-child(4),#balanceTable td:nth-child(4){text-align:right;font-variant-numeric:tabular-nums}
#balanceTable th:nth-child(5),#balanceTable td:nth-child(5){white-space:nowrap}
/* Step 2 issue highlighting */
.row-issue td{ background:#FFF7ED; }
/* New: issues cell chips */
.issues{ display:flex; flex-wrap:wrap; gap:6px; }
.issue-pill{
  font-size:11px; padding:2px 8px; border-radius:999px;
  background:#FEF3C7; border:1px solid #FDE68A; color:#92400E;
}
.issue-legend{ color:#6b7280; font-size:12px; margin-top:6px }
/* Document-style rosters */
#rosterDoc{ display:flex; flex-direction:column; gap:12px; }
.roster-section{
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  box-shadow:0 1px 0 rgba(0,0,0,.02);
  overflow:hidden;
}
.roster-header{
  background:#f3f4f6;
  font-weight:800;
  text-align:center;
  font-size:16px;
  padding:10px 12px;
}
.roster-header .ws-name{ font-weight:900 }
.roster-header .instructor{ font-weight:800 }
.roster-header .room{ color:#374151 }
.roster-header .count{ font-weight:800; white-space:nowrap }
/* 3 columns desktop → 2 tablet → 1 phone */
.name-grid{
  padding:8px 10px 12px 10px;
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:6px 24px;
}
@media (max-width: 900px){ .name-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
@media (max-width: 560px){ .name-grid{ grid-template-columns: 1fr; } }
.name{
  padding:2px 0;
  border-bottom:1px solid var(--line-soft);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.name:last-child{ border-bottom:0 }
.nojs{background:#fff3cd;color:#3b2a00;border:1px solid #ffe69c;padding:10px;border-radius:10px;margin:12px 0}
@media print{.header,.tabs,.printbar,.badge{display:none !important}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
</head>
<body>
<noscript><div class="wrap"><div class="nojs">JavaScript is disabled. Turn it on to use Workshop Sorter.</div></div></noscript>
<div class="header">
  <div class="wrap brand"><div class="title">Workshop Sorter</div></div>
</div>
<div class="wrap" id="appRoot" aria-busy="true">
  <!-- STEP 1 -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <div class="badge">step 1 of 3</div>
        <div style="margin-top:6px">Define workshops before loading students</div>
      </div>
      <div class="two" style="align-items:end;min-width:360px">
        <div>
          <label class="small">How many workshops (1–20)</label>
          <select id="numWorkshops"><option value="0">Select count</option></select>
        </div>
        <button id="buildWorkshopRows" class="ghost">Create rows</button>
      </div>
    </div>
    <div class="two" style="margin-top:10px">
      <div>
        <label class="small">Upload Workshops CSV (Instructor, Workshop, [Room], [Capacity])</label>
        <input id="workshopCsvFile" type="file" accept=".csv">
      </div>
      <div id="workshopDrop" class="dropzone" tabindex="0" role="button" aria-label="Drop workshops CSV here or click to browse">Drag and drop Workshops CSV here</div>
    </div>
    <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap">
      <button id="importWorkshopsBtn" class="ghost">Import workshops</button>
      <button id="addWorkshopRow" class="smallbtn" title="Add a new row">Add workshop</button>
      <button id="undoDelete" class="smallbtn" title="Undo last delete" disabled>Undo delete</button>
      <button id="clearWorkshops" class="smallbtn">Clear all</button>
    </div>
    <fieldset id="wkFieldset" style="margin-top:10px;border:0;padding:0">
      <div id="wkContainer"></div>
    </fieldset>
    <div id="wkErrors" class="helper hidden"></div>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <div class="locknote hidden" id="lockNote">Workshops are locked. Click Reset all in Step 3 to start over.</div>
      <button id="lockWorkshops" class="primary">Lock workshops and continue</button>
    </div>
    <div class="note" style="margin-top:6px">Capacity and Room import from CSV if present. Capacity defaults to 12 if blank.</div>
  </div>
  <!-- STEP 2 -->
  <div class="card">
    <div class="badge">step 2 of 3</div>
    <div style="margin-top:6px">Load students with three ranked choices</div>
    <div class="two">
      <div>
        <label class="small">
          Upload CSV with columns: Last, First, School, Choice1, Choice2, Choice3
          <br>(Also supports legacy "Student, Choice1, Choice2, Choice3")
        </label>
        <input id="csvFile" type="file" accept=".csv" disabled>
      </div>
      <div id="studentDrop" class="dropzone disabled" tabindex="0" role="button" aria-label="Drop students CSV here or click to browse">Drag and drop Student CSV here</div>
    </div>
    <div id="studentsPreview" class="hidden" style="margin-top:10px">
      <div class="badge">loaded students</div>
      <div class="scrollbox">
        <table id="studentsTable" class="report">
          <thead>
            <tr>
              <th>Last Name</th><th>First Name</th><th>School</th>
              <th>First Choice</th><th>Second Choice</th><th>Third Choice</th><th>Issues</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="issueLegend" class="issue-legend hidden">
        Issues show the reason a student is flagged. Examples: Missing one or more choices, Duplicate choices, Unknown workshop name.
      </div>
      <div class="printbar" style="margin-top:8px">
        <button id="printStudents" class="ghost">Export students (PDF)</button>
        <button id="exportStudentsCsv" class="ghost">Export students (.csv)</button>
      </div>
    </div>
  </div>
  <!-- STEP 3 -->
  <div class="card">
    <div class="badge">step 3 of 3</div>
    <div style="margin-top:6px">Run assignment and review the report</div>
    <div class="row" style="gap:12px">
      <button id="runBtn" class="primary" disabled>Run assignment</button>
      <button id="resetAll" class="ghost">Reset all</button>
    </div>
  </div>
  <!-- RESULTS -->
  <div id="resultsCard" class="card hidden">
    <div class="tabs">
      <div id="tabSummary" class="tab active">Summary</div>
      <div id="tabStudents" class="tab">Student assignments</div>
      <div id="tabRosters" class="tab">Workshop rosters</div>
      <div id="tabUnplaced" class="tab">Unplaced students</div>
    </div>
    <div class="panel">
      <div id="panelSummary">
        <div class="kv" style="display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:8px">
          <div>Total students: <span id="kvStudents"></span></div>
          <div>Total workshops: <span id="kvWorkshops"></span></div>
          <div>Total capacity: <span id="kvCapacity"></span></div>
          <div>Unplaced: <span id="kvUnplaced"></span></div>
        </div>
        <table id="balanceTable" class="report">
          <colgroup>
            <col style="width:28%"><col style="width:34%"><col style="width:12%"><col style="width:12%"><col style="width:14%">
          </colgroup>
          <thead><tr><th>Instructor</th><th>Workshop</th><th>Capacity</th><th>Assigned</th><th>Room</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="printbar">
          <button id="printSummary" class="ghost">Export summary (PDF)</button>
          <button id="exportSummaryCsv" class="ghost">Export summary (.csv)</button>
        </div>
      </div>
      <div id="panelStudents" class="hidden">
        <div class="scrollbox">
          <table id="studentTable" class="report">
            <thead><tr><th>Last Name</th><th>First Name</th><th>School</th><th>Assigned workshop</th><th>Room</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="printbar">
          <button id="printAssignments" class="ghost">Export assignments (PDF)</button>
          <button id="exportAssignmentsCsv" class="ghost">Export assignments (.csv)</button>
        </div>
      </div>
      <div id="panelRosters" class="hidden">
        <div class="scrollbox">
          <div id="rosterDoc"></div>
        </div>
        <div class="printbar">
          <button id="printRosters" class="ghost">Export rosters (PDF)</button>
          <button id="exportRostersCsv" class="ghost">Export rosters (.csv)</button>
        </div>
      </div>
      <div id="panelUnplaced" class="hidden">
        <div class="scrollbox">
          <table id="unplacedTable" class="report">
            <thead><tr><th>Last Name</th><th>First Name</th><th>School</th><th>Preference</th><th>Reason</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="printbar">
          <button id="printUnplaced" class="ghost">Export unplaced (PDF)</button>
          <button id="exportUnplacedCsv" class="ghost">Export unplaced (.csv)</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
function showInitError(msg){
  try{
    const root=document.getElementById('appRoot');
    if(!root) return;
    const d=document.createElement('div');
    d.className='nojs';
    d.textContent='There was an error initializing the app: ' + (msg||'unknown error');
    root.prepend(d);
  }catch(_){}
}
try{
  ['dragenter','dragover','drop'].forEach(evt=>{
    document.addEventListener(evt, e=>{
      if (e.target && e.target.closest && e.target.closest('.dropzone')) return;
      if (evt !== 'drop') { e.preventDefault(); if (e.dataTransfer) e.dataTransfer.dropEffect = 'none'; }
      else { e.preventDefault(); }
    }, {passive:false});
  });
  const numWorkshops=document.getElementById('numWorkshops');
  const buildWorkshopRows=document.getElementById('buildWorkshopRows');
  const workshopCsvFile=document.getElementById('workshopCsvFile');
  const workshopDrop=document.getElementById('workshopDrop');
  const importWorkshopsBtn=document.getElementById('importWorkshopsBtn');
  const addWorkshopRowBtn=document.getElementById('addWorkshopRow');
  const undoDeleteBtn=document.getElementById('undoDelete');
  const wkFieldset=document.getElementById('wkFieldset');
  const wkContainer=document.getElementById('wkContainer');
  const wkErrors=document.getElementById('wkErrors');
  const lockWorkshops=document.getElementById('lockWorkshops');
  const clearWorkshops=document.getElementById('clearWorkshops');
  const lockNote=document.getElementById('lockNote');
  const csvFile=document.getElementById('csvFile');
  const studentDrop=document.getElementById('studentDrop');
  const resultsCard=document.getElementById('resultsCard');
  const tabSummary=document.getElementById('tabSummary');
  const tabStudents=document.getElementById('tabStudents');
  const tabRosters=document.getElementById('tabRosters');
  const tabUnplaced=document.getElementById('tabUnplaced');
  const panelSummary=document.getElementById('panelSummary');
  const panelStudents=document.getElementById('panelStudents');
  const panelRosters=document.getElementById('panelRosters');
  const panelUnplaced=document.getElementById('panelUnplaced');
  const kvStudents=document.getElementById('kvStudents');
  const kvWorkshops=document.getElementById('kvWorkshops');
  const kvCapacity=document.getElementById('kvCapacity');
  const kvUnplaced=document.getElementById('kvUnplaced');
  const balanceTableBody=document.querySelector('#balanceTable tbody');
  const studentTableBody=document.querySelector('#studentTable tbody');
  const rosterDoc=document.getElementById('rosterDoc');
  const unplacedTableBody=document.querySelector('#unplacedTable tbody');
  const studentsPreview=document.getElementById('studentsPreview');
  const studentsTableBody=document.querySelector('#studentsTable tbody');
  const runBtn=document.getElementById('runBtn');
  const printStudentsBtn=document.getElementById('printStudents');
  const exportStudentsCsvBtn=document.getElementById('exportStudentsCsv');
  const printSummaryBtn=document.getElementById('printSummary');
  const exportSummaryCsvBtn=document.getElementById('exportSummaryCsv');
  const printAssignmentsBtn=document.getElementById('printAssignments');
  const exportAssignmentsCsvBtn=document.getElementById('exportAssignmentsCsv');
  const printRostersBtn=document.getElementById('printRosters');
  const exportRostersCsvBtn=document.getElementById('exportRostersCsv');
  const printUnplacedBtn=document.getElementById('printUnplaced');
  const exportUnplacedCsvBtn=document.getElementById('exportUnplacedCsv');
  if(!numWorkshops || !buildWorkshopRows || !wkContainer){ showInitError('Missing core DOM nodes.'); throw new Error('missing anchors'); }
  let locked=false;
  let workshopList=[];
  let students=[];
  let assignMap=new Map();
  let assignedRows=[];
  let unplaced=[];
  let deletedStack=[];
  document.addEventListener('DOMContentLoaded',()=>{
    for(let i=1;i<=20;i++){const o=document.createElement('option');o.value=o.textContent=String(i);numWorkshops.appendChild(o);}
    document.getElementById('appRoot')?.setAttribute('aria-busy','false');
  });
  const normalize=(s)=>{
    let t = s == null ? '' : String(s).trim();
    t = t.replace(/['']/g,"'").replace(/[""]/g,'"').replace(/[‐-–—]/g,'-');
    t = t.replace(/\s*&\s*/gi,' and ');
    t = t.replace(/\s+/g,' ').replace(/\s*[.,:;!?]+$/,'').trim();
    return t;
  };
  const key=(s)=> normalize(s).toLowerCase()
    .replace(/[^a-z0-9 -]/g,'')
    .replace(/\bthe\b/g,'')
    .replace(/\s+/g,' ')
    .trim();
  const tokens=(s)=> key(s).split(' ').filter(Boolean);
  const jaccard=(a,b)=>{
    const A=new Set(a), B=new Set(b);
    let inter=0; for(const x of A){ if(B.has(x)) inter++; }
    const uni=new Set([...A,...B]).size || 1;
    return inter/uni;
  };
  function findWorkshopIndexByName(name){
    if(!name) return -1;
    const k = key(name);
    const exactIdx = workshopList.findIndex(w => key(w.name) === k);
    if(exactIdx !== -1) return exactIdx;
    const t = tokens(name);
    let best = {idx:-1, score:0};
    workshopList.forEach((w,i)=>{
      const score = jaccard(t, tokens(w.name));
      if(score > best.score) best = {idx:i, score};
    });
    return best.score >= 0.6 ? best.idx : -1;
  }
  const enableRunIfReady=()=>{ runBtn.disabled=!(locked && students.length>0); };
  let runSeed='';
  const makeSeed=()=>{ try{const a=new Uint32Array(2);crypto.getRandomValues(a);return a[0]+'-'+a[1];}catch(_){return Date.now()+'-'+Math.floor(Math.random()*1e9)}};
  const setRunSeed=(s)=>{ runSeed=String(s||makeSeed()); };
  function setDropHandlers({zone, onFile, input, acceptExts=['.csv']}){
    if(!zone) return;
    let dragDepth = 0;
    const isDisabled = ()=> zone.classList.contains('disabled') || zone.hasAttribute('aria-disabled');
    const highlight  = ()=>{ if(!isDisabled()) zone.classList.add('drag'); };
    const unhighlight= ()=> zone.classList.remove('drag');
    const openPicker = ()=>{ if(input && !isDisabled()){ input.click(); } };
    zone.addEventListener('click', openPicker);
    zone.addEventListener('keydown', (e)=>{ if((e.key==='Enter'||e.key===' ') && !isDisabled()){ e.preventDefault(); openPicker(); } });
    const hasFilesType = (dt)=> {
      try{ const types = dt && dt.types ? Array.from(dt.types) : []; return !types.length || types.includes('Files'); }
      catch{ return true; }
    };
    const pickFile = (dt)=> dt?.files?.[0] || null;
    const isAccepted = (file)=> acceptExts.some(ext => (file?.name||'').toLowerCase().endsWith(ext));
    zone.addEventListener('dragenter', (e)=>{ if(isDisabled()) return; if(!hasFilesType(e.dataTransfer)) return; e.preventDefault(); dragDepth++; highlight(); }, {passive:false});
    zone.addEventListener('dragover',  (e)=>{ if(isDisabled()) return; if(!hasFilesType(e.dataTransfer)) return; e.preventDefault(); if(e.dataTransfer) e.dataTransfer.dropEffect='copy'; }, {passive:false});
    zone.addEventListener('dragleave', (e)=>{ if(isDisabled()) return; e.preventDefault(); dragDepth=Math.max(0,dragDepth-1); if(dragDepth===0) unhighlight(); }, {passive:false});
    zone.addEventListener('drop',      (e)=>{ if(isDisabled()) return; e.preventDefault(); dragDepth=0; unhighlight(); const f=pickFile(e.dataTransfer); if(!f){ alert('Drop a .csv file.'); return; } if(!isAccepted(f)){ alert('Please drop a .csv file.'); return; } if(input){ const dt=new DataTransfer(); dt.items.add(f); input.files=dt.files; } onFile(f); }, {passive:false});
  }
  function setWorkshopControlsEnabled(enabled){
    numWorkshops.disabled=!enabled;
    buildWorkshopRows.disabled=!enabled;
    addWorkshopRowBtn.disabled=!enabled;
    importWorkshopsBtn.disabled=!enabled;
    workshopCsvFile.disabled=!enabled;
    workshopDrop?.classList.toggle('disabled',!enabled);
    undoDeleteBtn.disabled=!enabled || deletedStack.length===0;
    clearWorkshops.disabled=!enabled;
  }
  buildWorkshopRows.onclick=()=>{
    const n=parseInt(numWorkshops.value,10);
    if(!n||n<1||n>20){alert('Choose 1 to 20 workshops');return;}
    renderWorkshopGrid(n);
  };
  function ensureHeader(){
    if(!wkContainer.querySelector('.wkHeader')){
      const header=document.createElement('div');
      header.className='wkHeader';
      header.innerHTML=`<div class="five" style="font-size:12px;color:#6b7280;margin-bottom:6px">
        <div>Instructor</div><div>Workshop name</div><div>Capacity</div><div>Room (optional)</div><div></div></div>`;
      wkContainer.appendChild(header);
    }
  }
  function newRow({instructor='',name='',capacity='12',room=''}={}){
    const row=document.createElement('div');
    row.className='five wkRow';
    row.innerHTML=`<input type="text" class="wkInstructor" placeholder="Instructor name" value="${instructor}">
      <input type="text" class="wkName" placeholder="Workshop" value="${name}">
      <input type="number" class="wkCap" min="1" value="${capacity}">
      <input type="text" class="wkRoom" placeholder="e.g., BH 101 (optional)" value="${room}">
      <button type="button" class="smallbtn wkDel" title="Delete this row">×</button>`;
    wkContainer.appendChild(row);
  }
  function renderWorkshopGrid(n){
    wkContainer.innerHTML="";
    ensureHeader();
    deletedStack=[]; updateUndoState();
    for(let i=0;i<n;i++) newRow({capacity:''});
  }
  addWorkshopRowBtn.onclick=()=>{ if(locked) return; ensureHeader(); newRow(); };
  wkContainer.addEventListener('click',(e)=>{
    const btn=e.target.closest?.('.wkDel'); if(!btn || locked) return;
    const row=btn.closest('.wkRow'); if(!row) return;
    const fields=row.querySelectorAll('input');
    const saved={ instructor:fields[0]?.value||'', name:fields[1]?.value||'', capacity:fields[2]?.value||'', room:fields[3]?.value||'' };
    deletedStack.push(saved);
    row.remove();
    updateUndoState();
  });
  function updateUndoState(){ undoDeleteBtn.disabled = locked || deletedStack.length===0; }
  undoDeleteBtn.onclick=()=>{
    if(!deletedStack.length || locked) return;
    const data=deletedStack.pop();
    ensureHeader(); newRow(data);
    updateUndoState();
  };
  function readWorkshops(){
    const rows=wkContainer.querySelectorAll('.wkRow');
    const out=[]; const errors=[];
    rows.forEach((r,i)=>{
      const instr=r.querySelector('.wkInstructor').value.trim();
      const nm=r.querySelector('.wkName').value.trim();
      const capRaw=r.querySelector('.wkCap').value.trim();
      const room=r.querySelector('.wkRoom').value.trim();
      if(!instr && !nm && !capRaw) return;
      if(!instr) errors.push(`Row ${i+1}: Instructor is blank.`);
      if(!nm) errors.push(`Row ${i+1}: Workshop name is blank.`);
      const cap=parseInt(capRaw,10)||12;
      out.push({name:normalize(nm), instructor:normalize(instr), capacity:cap, room:room||''});
    });
    return {workshops:out, errors};
  }
  lockWorkshops.onclick=()=>{
    if(locked) return;
    const {workshops, errors}=readWorkshops();
    if(errors.length){
      alert('Validation errors:\n'+errors.join('\n'));
      return;
    }
    if(!workshops.length){
      alert('Add at least one workshop first.');
      return;
    }
    workshopList=workshops;
    locked=true;
    setWorkshopControlsEnabled(false);
    lockWorkshops.classList.add('hidden');
    lockNote.classList.remove('hidden');
    csvFile.disabled=false;
    studentDrop.classList.remove('disabled');
    enableRunIfReady();
  };
  clearWorkshops.onclick=()=>{
    if(locked) return;
    if(!confirm('Clear all workshops?')) return;
    wkContainer.innerHTML='';
    deletedStack=[]; updateUndoState();
  };
  function parseWorkshopCSV(text){
    const lines=text.trim().split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(!lines.length) return [];
    const data=[]; const header=lines[0].toLowerCase();
    const hasHeader=/instructor|workshop|room|capacity/.test(header);
    const start=hasHeader?1:0;
    for(let i=start;i<lines.length;i++){
      const parts=lines[i].split(',').map(p=>p.replace(/^"|"$/g,'').trim());
      if(parts.length<2) continue;
      const instructor=parts[0]||'', name=parts[1]||'', room=parts[2]||'', capRaw=parts[3]||'';
      const capacity=parseInt(capRaw,10)||12;
      data.push({instructor:normalize(instructor),name:normalize(name),room,capacity});
    }
    return data;
  }
  function loadWorkshopCSV(file){
    const r=new FileReader();
    r.onload=()=>{
      const items=parseWorkshopCSV(r.result);
      if(!items.length){alert('No valid workshops found in CSV.');return;}
      wkContainer.innerHTML='';
      ensureHeader();
      deletedStack=[]; updateUndoState();
      items.forEach(w=>newRow(w));
    };
    r.readAsText(file);
  }
  workshopCsvFile.onchange=()=>{ if(workshopCsvFile.files?.length) loadWorkshopCSV(workshopCsvFile.files[0]); };
  importWorkshopsBtn.onclick=()=>{ workshopCsvFile.click(); };
  setDropHandlers({zone:workshopDrop, onFile:loadWorkshopCSV, input:workshopCsvFile});
  function parseStudentCSV(text){
    const lines=text.trim().split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(lines.length<2) return [];
    const hdr=lines[0].toLowerCase();
    const isLegacy=/student.*choice1/.test(hdr);
    const isNew=/last.*first.*school/.test(hdr);
    if(!isLegacy && !isNew){
      alert('Unexpected CSV format. Expected headers: Last,First,School,Choice1,Choice2,Choice3 (or legacy Student,Choice1,Choice2,Choice3)');
      return [];
    }
    const out=[];
    for(let i=1;i<lines.length;i++){
      const parts=lines[i].split(',').map(p=>p.replace(/^"|"$/g,'').trim());
      let last,first,school,c1,c2,c3;
      if(isLegacy){
        const fullName=parts[0]||'';
        last=fullName; first=''; school='';
        c1=parts[1]||'';c2=parts[2]||'';c3=parts[3]||'';
      }else{
        last=parts[0]||'';first=parts[1]||'';school=parts[2]||'';
        c1=parts[3]||'';c2=parts[4]||'';c3=parts[5]||'';
      }
      const label= first ? `${last}, ${first}` : last;
      const preferences=[normalize(c1),normalize(c2),normalize(c3)];
      out.push({id:i, last, first, school, label, preferences});
    }
    return out;
  }
  function loadStudentCSV(file){
    const r=new FileReader();
    r.onload=()=>{
      students=parseStudentCSV(r.result);
      if(!students.length){return;}
      renderStudentsPreview();
      enableRunIfReady();
      setRunSeed();
    };
    r.readAsText(file);
  }
  csvFile.onchange=()=>{ if(csvFile.files?.length) loadStudentCSV(csvFile.files[0]); };
  setDropHandlers({zone:studentDrop, onFile:loadStudentCSV, input:csvFile});
  function renderStudentsPreview(){
    studentsTableBody.innerHTML='';
    let anyIssue=false;
    students.forEach(s=>{
      const row=document.createElement('tr');
      const issues=[];
      s.preferences.forEach((p,idx)=>{
        if(!p) issues.push(`Missing choice ${idx+1}`);
        else{
          const widx=findWorkshopIndexByName(p);
          if(widx===-1) issues.push(`Unknown: "${p}"`);
        }
      });
      const dup=new Set();
      s.preferences.filter(Boolean).forEach(p=>{if(dup.has(key(p))) issues.push('Duplicate choices'); dup.add(key(p));});
      if(issues.length) anyIssue=true;
      if(issues.length) row.classList.add('row-issue');
      const issueCell=issues.length? `<div class="issues">${issues.map(x=>`<span class="issue-pill">${x}</span>`).join('')}</div>` : '';
      row.innerHTML=`<td>${s.last||''}</td><td>${s.first||''}</td><td>${s.school||''}</td>
        <td>${s.preferences[0]||''}</td><td>${s.preferences[1]||''}</td><td>${s.preferences[2]||''}</td><td>${issueCell}</td>`;
      studentsTableBody.appendChild(row);
    });
    studentsPreview.classList.remove('hidden');
    const legend=document.getElementById('issueLegend');
    if(anyIssue) legend.classList.remove('hidden'); else legend.classList.add('hidden');
  }
  document.getElementById('resetAll').onclick=()=>{
    if(!confirm('Reset all data (workshops, students, results)?')) return;
    locked=false; workshopList=[]; students=[]; assignMap.clear(); assignedRows=[]; unplaced=[];
    wkContainer.innerHTML=''; deletedStack=[]; updateUndoState();
    setWorkshopControlsEnabled(true);
    lockWorkshops.classList.remove('hidden');
    lockNote.classList.add('hidden');
    csvFile.disabled=true; csvFile.value='';
    studentDrop.classList.add('disabled');
    studentsPreview.classList.add('hidden');
    studentsTableBody.innerHTML='';
    resultsCard.classList.add('hidden');
    runBtn.disabled=true;
  };
  runBtn.onclick=()=>{
    if(!locked || !students.length) return;
    assignMap.clear(); assignedRows=[]; unplaced=[];
    const slots=[];
    workshopList.forEach(w=>{
      for(let i=0;i<w.capacity;i++) slots.push({workshop:w.name, student:null, instructor:w.instructor, room:w.room||''});
    });
    const shuffledStudents=students.slice(); shuffleArray(shuffledStudents,runSeed);
    const assigned=new Set();
    for(let pass=1;pass<=3;pass++){
      shuffledStudents.forEach(s=>{
        if(assigned.has(s.id)) return;
        const pref=s.preferences[pass-1]; if(!pref) return;
        const widx=findWorkshopIndexByName(pref); if(widx===-1) return;
        const wname=workshopList[widx].name;
        const freeSlot=slots.find(sl=>sl.workshop===wname && !sl.student);
        if(freeSlot){
          freeSlot.student=s.id; assignMap.set(s.id,wname); assigned.add(s.id); assignedRows.push({...s, workshop:wname, room:freeSlot.room});
        }
      });
    }
    students.forEach(s=>{
      if(!assigned.has(s.id)){
        const prefs=s.preferences.filter(Boolean).map(p=>`"${p}"`).join(', ')||'none';
        unplaced.push({...s, preferences:prefs, reason:'No available slot'});
      }
    });
    renderResults();
    resultsCard.classList.remove('hidden');
  };
  function shuffleArray(arr,seed){
    const rng=xm

Decided on code compilation approach
Here's the complete Workshop Sorter HTML code. Copy and paste this entire code into a file named workshop-sorter.html:

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Workshop Sorter</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --lsu-purple:#461D7C; --lsu-gold:#FDD023; --ink:#1f2430; --muted:#6b7280;
  --line:#d1d5db; --line-soft:#e5e7eb; --bg:#fafafa; --card:#ffffff;
  --brand-font: Inter, system-ui, "Segoe UI", Roboto, Arial, sans-serif;
  --radius:14px; --radius-sm:10px; --shadow:0 1px 2px rgba(0,0,0,.04);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--brand-font);line-height:1.4}
.header{background:linear-gradient(90deg,var(--lsu-purple),#2d1252);color:#fff;padding:24px 16px}
.wrap{max-width:1120px;margin:0 auto;padding:16px}
.brand{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.brand .title{font-size:22px;letter-spacing:.2px}
.card{background:var(--card);border:1px solid var(--line-soft);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);margin-bottom:14px}
label.small{font-size:12px;color:var(--muted)}
select,input[type=file],input[type=text],input[type=number]{width:100%;padding:10px;border:1px solid var(--line-soft);border-radius:var(--radius-sm);background:#fff;transition:border-color .15s,box-shadow .15s}
select:focus,input:focus{outline:0;border-color:var(--lsu-purple);box-shadow:0 0 0 3px rgba(70,29,124,.15)}
input.invalid{border-color:#dc2626;background:#fff5f5}
button{font-family:inherit;cursor:pointer;border-radius:12px;font-weight:600}
button.primary{background:var(--lsu-gold);color:#3a2b00;border:0;padding:12px 18px}
button.primary:hover{filter:brightness(.98)}
button.primary:focus{outline:0;box-shadow:0 0 0 3px rgba(253,208,35,.35)}
button.ghost{background:#fff;border:1px solid var(--line-soft);padding:10px 14px}
.smallbtn{padding:8px 10px;border-radius:10px;border:1px solid var(--line-soft);background:#fff}
button[disabled]{opacity:.55;cursor:not-allowed}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.five{display:grid;grid-template-columns:1fr 1fr 130px 120px 36px;gap:10px;align-items:center}
.hidden{display:none}
.badge{font-size:12px;padding:2px 8px;border:1px solid var(--line-soft);border-radius:999px;color:#6b7280}
.note{color:var(--muted);font-size:12px}
.tabs{display:flex;gap:8px;margin:8px 0 0}
.tab{padding:8px 12px;border:1px solid var(--line-soft);border-bottom:0;border-radius:10px 10px 0 0;background:#f8fafc;cursor:pointer}
.tab.active{background:#fff;border-color:var(--lsu-purple);color:#lsu-purple}
.panel{border:1px solid var(--line-soft);border-radius:0 12px 12px 12px;background:#fff;padding:12px}
/* drop zones */
.dropzone{display:flex;align-items:center;justify-content:center;border:2px dashed var(--line);border-radius:12px;min-height:44px;color:#6b7280;background:#fff; user-select:none}
.dropzone.drag{border-color:var(--lsu-purple);background:#faf5ff}
.dropzone.disabled{opacity:.6;pointer-events:none}
/* generic scrollbox */
.scrollbox{
  max-height:420px;
  overflow:auto;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
}
/* tables */
table{width:100%}
table.report{
  border-collapse:separate;border-spacing:0;border:1px solid var(--line);
  border-radius:12px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.02);
}
.report thead th{
  background:#f8fafc;font-weight:600;
  position:sticky; top:0; z-index:1;
}
.report th,.report td{
  padding:10px 12px;text-align:left;vertical-align:top;
  border-right:1px solid var(--line-soft);border-bottom:1px solid var(--line-soft);
}
.report th:last-child,.report td:last-child{border-right:0}
.report tr:last-child td{border-bottom:0}
/* Summary align */
#balanceTable th:nth-child(3),#balanceTable td:nth-child(3),
#balanceTable th:nth-child(4),#balanceTable td:nth-child(4){text-align:right;font-variant-numeric:tabular-nums}
#balanceTable th:nth-child(5),#balanceTable td:nth-child(5){white-space:nowrap}
/* Step 2 issue highlighting */
.row-issue td{ background:#FFF7ED; }
/* New: issues cell chips */
.issues{ display:flex; flex-wrap:wrap; gap:6px; }
.issue-pill{
  font-size:11px; padding:2px 8px; border-radius:999px;
  background:#FEF3C7; border:1px solid #FDE68A; color:#92400E;
}
.issue-legend{ color:#6b7280; font-size:12px; margin-top:6px }
/* Document-style rosters */
#rosterDoc{ display:flex; flex-direction:column; gap:12px; }
.roster-section{
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  box-shadow:0 1px 0 rgba(0,0,0,.02);
  overflow:hidden;
}
.roster-header{
  background:#f3f4f6;
  font-weight:800;
  text-align:center;
  font-size:16px;
  padding:10px 12px;
}
.roster-header .ws-name{ font-weight:900 }
.roster-header .instructor{ font-weight:800 }
.roster-header .room{ color:#374151 }
.roster-header .count{ font-weight:800; white-space:nowrap }
/* 3 columns desktop → 2 tablet → 1 phone */
.name-grid{
  padding:8px 10px 12px 10px;
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:6px 24px;
}
@media (max-width: 900px){ .name-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
@media (max-width: 560px){ .name-grid{ grid-template-columns: 1fr; } }
.name{
  padding:2px 0;
  border-bottom:1px solid var(--line-soft);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.name:last-child{ border-bottom:0 }
.nojs{background:#fff3cd;color:#3b2a00;border:1px solid #ffe69c;padding:10px;border-radius:10px;margin:12px 0}
@media print{.header,.tabs,.printbar,.badge{display:none !important}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
</head>
<body>
<noscript><div class="wrap"><div class="nojs">JavaScript is disabled. Turn it on to use Workshop Sorter.</div></div></noscript>
<div class="header">
  <div class="wrap brand"><div class="title">Workshop Sorter</div></div>
</div>
<div class="wrap" id="appRoot" aria-busy="true">
  <!-- STEP 1 -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <div class="badge">step 1 of 3</div>
        <div style="margin-top:6px">Define workshops before loading students</div>
      </div>
      <div class="two" style="align-items:end;min-width:360px">
        <div>
          <label class="small">How many workshops (1–20)</label>
          <select id="numWorkshops"><option value="0">Select count</option></select>
        </div>
        <button id="buildWorkshopRows" class="ghost">Create rows</button>
      </div>
    </div>
    <div class="two" style="margin-top:10px">
      <div>
        <label class="small">Upload Workshops CSV (Instructor, Workshop, [Room], [Capacity])</label>
        <input id="workshopCsvFile" type="file" accept=".csv">
      </div>
      <div id="workshopDrop" class="dropzone" tabindex="0" role="button" aria-label="Drop workshops CSV here or click to browse">Drag and drop Workshops CSV here</div>
    </div>
    <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap">
      <button id="importWorkshopsBtn" class="ghost">Import workshops</button>
      <button id="addWorkshopRow" class="smallbtn" title="Add a new row">Add workshop</button>
      <button id="undoDelete" class="smallbtn" title="Undo last delete" disabled>Undo delete</button>
      <button id="clearWorkshops" class="smallbtn">Clear all</button>
    </div>
    <fieldset id="wkFieldset" style="margin-top:10px;border:0;padding:0">
      <div id="wkContainer"></div>
    </fieldset>
    <div id="wkErrors" class="helper hidden"></div>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <div class="locknote hidden" id="lockNote">Workshops are locked. Click Reset all in Step 3 to start over.</div>
      <button id="lockWorkshops" class="primary">Lock workshops and continue</button>
    </div>
    <div class="note" style="margin-top:6px">Capacity and Room import from CSV if present. Capacity defaults to 12 if blank.</div>
  </div>
  <!-- STEP 2 -->
  <div class="card">
    <div class="badge">step 2 of 3</div>
    <div style="margin-top:6px">Load students with three ranked choices</div>
    <div class="two">
      <div>
        <label class="small">
          Upload CSV with columns: Last, First, School, Choice1, Choice2, Choice3
          <br>(Also supports legacy "Student, Choice1, Choice2, Choice3")
        </label>
        <input id="csvFile" type="file" accept=".csv" disabled>
      </div>
      <div id="studentDrop" class="dropzone disabled" tabindex="0" role="button" aria-label="Drop students CSV here or click to browse">Drag and drop Student CSV here</div>
    </div>
    <div id="studentsPreview" class="hidden" style="margin-top:10px">
      <div class="badge">loaded students</div>
      <div class="scrollbox">
        <table id="studentsTable" class="report">
          <thead>
            <tr>
              <th>Last Name</th><th>First Name</th><th>School</th>
              <th>First Choice</th><th>Second Choice</th><th>Third Choice</th><th>Issues</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="issueLegend" class="issue-legend hidden">
        Issues show the reason a student is flagged. Examples: Missing one or more choices, Duplicate choices, Unknown workshop name.
      </div>
      <div class="printbar" style="margin-top:8px">
        <button id="printStudents" class="ghost">Export students (PDF)</button>
        <button id="exportStudentsCsv" class="ghost">Export students (.csv)</button>
      </div>
    </div>
  </div>
  <!-- STEP 3 -->
  <div class="card">
    <div class="badge">step 3 of 3</div>
    <div style="margin-top:6px">Run assignment and review the report</div>
    <div class="row" style="gap:12px">
      <button id="runBtn" class="primary" disabled>Run assignment</button>
      <button id="resetAll" class="ghost">Reset all</button>
    </div>
  </div>
  <!-- RESULTS -->
  <div id="resultsCard" class="card hidden">
    <div class="tabs">
      <div id="tabSummary" class="tab active">Summary</div>
      <div id="tabStudents" class="tab">Student assignments</div>
      <div id="tabRosters" class="tab">Workshop rosters</div>
      <div id="tabUnplaced" class="tab">Unplaced students</div>
    </div>
    <div class="panel">
      <div id="panelSummary">
        <div class="kv" style="display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:8px">
          <div>Total students: <span id="kvStudents"></span></div>
          <div>Total workshops: <span id="kvWorkshops"></span></div>
          <div>Total capacity: <span id="kvCapacity"></span></div>
          <div>Unplaced: <span id="kvUnplaced"></span></div>
        </div>
        <table id="balanceTable" class="report">
          <colgroup>
            <col style="width:28%"><col style="width:34%"><col style="width:12%"><col style="width:12%"><col style="width:14%">
          </colgroup>
          <thead><tr><th>Instructor</th><th>Workshop</th><th>Capacity</th><th>Assigned</th><th>Room</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="printbar">
          <button id="printSummary" class="ghost">Export summary (PDF)</button>
          <button id="exportSummaryCsv" class="ghost">Export summary (.csv)</button>
        </div>
      </div>
      <div id="panelStudents" class="hidden">
        <div class="scrollbox">
          <table id="studentTable" class="report">
            <thead><tr><th>Last Name</th><th>First Name</th><th>School</th><th>Assigned workshop</th><th>Room</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="printbar">
          <button id="printAssignments" class="ghost">Export assignments (PDF)</button>
          <button id="exportAssignmentsCsv" class="ghost">Export assignments (.csv)</button>
        </div>
      </div>
      <div id="panelRosters" class="hidden">
        <div class="scrollbox">
          <div id="rosterDoc"></div>
        </div>
        <div class="printbar">
          <button id="printRosters" class="ghost">Export rosters (PDF)</button>
          <button id="exportRostersCsv" class="ghost">Export rosters (.csv)</button>
        </div>
      </div>
      <div id="panelUnplaced" class="hidden">
        <div class="scrollbox">
          <table id="unplacedTable" class="report">
            <thead><tr><th>Last Name</th><th>First Name</th><th>School</th><th>Preference</th><th>Reason</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="printbar">
          <button id="printUnplaced" class="ghost">Export unplaced (PDF)</button>
          <button id="exportUnplacedCsv" class="ghost">Export unplaced (.csv)</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
function showInitError(msg){
  try{
    const root=document.getElementById('appRoot');
    if(!root) return;
    const d=document.createElement('div');
    d.className='nojs';
    d.textContent='There was an error initializing the app: ' + (msg||'unknown error');
    root.prepend(d);
  }catch(_){}
}
try{
  ['dragenter','dragover','drop'].forEach(evt=>{
    document.addEventListener(evt, e=>{
      if (e.target && e.target.closest && e.target.closest('.dropzone')) return;
      if (evt !== 'drop') { e.preventDefault(); if (e.dataTransfer) e.dataTransfer.dropEffect = 'none'; }
      else { e.preventDefault(); }
    }, {passive:false});
  });
  const numWorkshops=document.getElementById('numWorkshops');
  const buildWorkshopRows=document.getElementById('buildWorkshopRows');
  const workshopCsvFile=document.getElementById('workshopCsvFile');
  const workshopDrop=document.getElementById('workshopDrop');
  const importWorkshopsBtn=document.getElementById('importWorkshopsBtn');
  const addWorkshopRowBtn=document.getElementById('addWorkshopRow');
  const undoDeleteBtn=document.getElementById('undoDelete');
  const wkFieldset=document.getElementById('wkFieldset');
  const wkContainer=document.getElementById('wkContainer');
  const wkErrors=document.getElementById('wkErrors');
  const lockWorkshops=document.getElementById('lockWorkshops');
  const clearWorkshops=document.getElementById('clearWorkshops');
  const lockNote=document.getElementById('lockNote');
  const csvFile=document.getElementById('csvFile');
  const studentDrop=document.getElementById('studentDrop');
  const resultsCard=document.getElementById('resultsCard');
  const tabSummary=document.getElementById('tabSummary');
  const tabStudents=document.getElementById('tabStudents');
  const tabRosters=document.getElementById('tabRosters');
  const tabUnplaced=document.getElementById('tabUnplaced');
  const panelSummary=document.getElementById('panelSummary');
  const panelStudents=document.getElementById('panelStudents');
  const panelRosters=document.getElementById('panelRosters');
  const panelUnplaced=document.getElementById('panelUnplaced');
  const kvStudents=document.getElementById('kvStudents');
  const kvWorkshops=document.getElementById('kvWorkshops');
  const kvCapacity=document.getElementById('kvCapacity');
  const kvUnplaced=document.getElementById('kvUnplaced');
  const balanceTableBody=document.querySelector('#balanceTable tbody');
  const studentTableBody=document.querySelector('#studentTable tbody');
  const rosterDoc=document.getElementById('rosterDoc');
  const unplacedTableBody=document.querySelector('#unplacedTable tbody');
  const studentsPreview=document.getElementById('studentsPreview');
  const studentsTableBody=document.querySelector('#studentsTable tbody');
  const runBtn=document.getElementById('runBtn');
  const printStudentsBtn=document.getElementById('printStudents');
  const exportStudentsCsvBtn=document.getElementById('exportStudentsCsv');
  const printSummaryBtn=document.getElementById('printSummary');
  const exportSummaryCsvBtn=document.getElementById('exportSummaryCsv');
  const printAssignmentsBtn=document.getElementById('printAssignments');
  const exportAssignmentsCsvBtn=document.getElementById('exportAssignmentsCsv');
  const printRostersBtn=document.getElementById('printRosters');
  const exportRostersCsvBtn=document.getElementById('exportRostersCsv');
  const printUnplacedBtn=document.getElementById('printUnplaced');
  const exportUnplacedCsvBtn=document.getElementById('exportUnplacedCsv');
  if(!numWorkshops || !buildWorkshopRows || !wkContainer){ showInitError('Missing core DOM nodes.'); throw new Error('missing anchors'); }
  let locked=false;
  let workshopList=[];
  let students=[];
  let assignMap=new Map();
  let assignedRows=[];
  let unplaced=[];
  let deletedStack=[];
  document.addEventListener('DOMContentLoaded',()=>{
    for(let i=1;i<=20;i++){const o=document.createElement('option');o.value=o.textContent=String(i);numWorkshops.appendChild(o);}
    document.getElementById('appRoot')?.setAttribute('aria-busy','false');
  });
  const normalize=(s)=>{
    let t = s == null ? '' : String(s).trim();
    t = t.replace(/['']/g,"'").replace(/[""]/g,'"').replace(/[‐-–—]/g,'-');
    t = t.replace(/\s*&\s*/gi,' and ');
    t = t.replace(/\s+/g,' ').replace(/\s*[.,:;!?]+$/,'').trim();
    return t;
  };
  const key=(s)=> normalize(s).toLowerCase()
    .replace(/[^a-z0-9 -]/g,'')
    .replace(/\bthe\b/g,'')
    .replace(/\s+/g,' ')
    .trim();
  const tokens=(s)=> key(s).split(' ').filter(Boolean);
  const jaccard=(a,b)=>{
    const A=new Set(a), B=new Set(b);
    let inter=0; for(const x of A){ if(B.has(x)) inter++; }
    const uni=new Set([...A,...B]).size || 1;
    return inter/uni;
  };
  function findWorkshopIndexByName(name){
    if(!name) return -1;
    const k = key(name);
    const exactIdx = workshopList.findIndex(w => key(w.name) === k);
    if(exactIdx !== -1) return exactIdx;
    const t = tokens(name);
    let best = {idx:-1, score:0};
    workshopList.forEach((w,i)=>{
      const score = jaccard(t, tokens(w.name));
      if(score > best.score) best = {idx:i, score};
    });
    return best.score >= 0.6 ? best.idx : -1;
  }
  const enableRunIfReady=()=>{ runBtn.disabled=!(locked && students.length>0); };
  let runSeed='';
  const makeSeed=()=>{ try{const a=new Uint32Array(2);crypto.getRandomValues(a);return a[0]+'-'+a[1];}catch(_){return Date.now()+'-'+Math.floor(Math.random()*1e9)}};
  const setRunSeed=(s)=>{ runSeed=String(s||makeSeed()); };
  function setDropHandlers({zone, onFile, input, acceptExts=['.csv']}){
    if(!zone) return;
    let dragDepth = 0;
    const isDisabled = ()=> zone.classList.contains('disabled') || zone.hasAttribute('aria-disabled');
    const highlight  = ()=>{ if(!isDisabled()) zone.classList.add('drag'); };
    const unhighlight= ()=> zone.classList.remove('drag');
    const openPicker = ()=>{ if(input && !isDisabled()){ input.click(); } };
    zone.addEventListener('click', openPicker);
    zone.addEventListener('keydown', (e)=>{ if((e.key==='Enter'||e.key===' ') && !isDisabled()){ e.preventDefault(); openPicker(); } });
    const hasFilesType = (dt)=> {
      try{ const types = dt && dt.types ? Array.from(dt.types) : []; return !types.length || types.includes('Files'); }
      catch{ return true; }
    };
    const pickFile = (dt)=> dt?.files?.[0] || null;
    const isAccepted = (file)=> acceptExts.some(ext => (file?.name||'').toLowerCase().endsWith(ext));
    zone.addEventListener('dragenter', (e)=>{ if(isDisabled()) return; if(!hasFilesType(e.dataTransfer)) return; e.preventDefault(); dragDepth++; highlight(); }, {passive:false});
    zone.addEventListener('dragover',  (e)=>{ if(isDisabled()) return; if(!hasFilesType(e.dataTransfer)) return; e.preventDefault(); if(e.dataTransfer) e.dataTransfer.dropEffect='copy'; }, {passive:false});
    zone.addEventListener('dragleave', (e)=>{ if(isDisabled()) return; e.preventDefault(); dragDepth=Math.max(0,dragDepth-1); if(dragDepth===0) unhighlight(); }, {passive:false});
    zone.addEventListener('drop',      (e)=>{ if(isDisabled()) return; e.preventDefault(); dragDepth=0; unhighlight(); const f=pickFile(e.dataTransfer); if(!f){ alert('Drop a .csv file.'); return; } if(!isAccepted(f)){ alert('Please drop a .csv file.'); return; } if(input){ const dt=new DataTransfer(); dt.items.add(f); input.files=dt.files; } onFile(f); }, {passive:false});
  }
  function setWorkshopControlsEnabled(enabled){
    numWorkshops.disabled=!enabled;
    buildWorkshopRows.disabled=!enabled;
    addWorkshopRowBtn.disabled=!enabled;
    importWorkshopsBtn.disabled=!enabled;
    workshopCsvFile.disabled=!enabled;
    workshopDrop?.classList.toggle('disabled',!enabled);
    undoDeleteBtn.disabled=!enabled || deletedStack.length===0;
    clearWorkshops.disabled=!enabled;
  }
  buildWorkshopRows.onclick=()=>{
    const n=parseInt(numWorkshops.value,10);
    if(!n||n<1||n>20){alert('Choose 1 to 20 workshops');return;}
    renderWorkshopGrid(n);
  };
  function ensureHeader(){
    if(!wkContainer.querySelector('.wkHeader')){
      const header=document.createElement('div');
      header.className='wkHeader';
      header.innerHTML=`<div class="five" style="font-size:12px;color:#6b7280;margin-bottom:6px">
        <div>Instructor</div><div>Workshop name</div><div>Capacity</div><div>Room (optional)</div><div></div></div>`;
      wkContainer.appendChild(header);
    }
  }
  function newRow({instructor='',name='',capacity='12',room=''}={}){
    const row=document.createElement('div');
    row.className='five wkRow';
    row.innerHTML=`<input type="text" class="wkInstructor" placeholder="Instructor name" value="${instructor}">
      <input type="text" class="wkName" placeholder="Workshop" value="${name}">
      <input type="number" class="wkCap" min="1" value="${capacity}">
      <input type="text" class="wkRoom" placeholder="e.g., BH 101 (optional)" value="${room}">
      <button type="button" class="smallbtn wkDel" title="Delete this row">×</button>`;
    wkContainer.appendChild(row);
  }
  function renderWorkshopGrid(n){
    wkContainer.innerHTML="";
    ensureHeader();
    deletedStack=[]; updateUndoState();
    for(let i=0;i<n;i++) newRow({capacity:''});
  }
  addWorkshopRowBtn.onclick=()=>{ if(locked) return; ensureHeader(); newRow(); };
  wkContainer.addEventListener('click',(e)=>{
    const btn=e.target.closest?.('.wkDel'); if(!btn || locked) return;
    const row=btn.closest('.wkRow'); if(!row) return;
    const fields=row.querySelectorAll('input');
    const snap={instructor:'',name:'',capacity:'12',room:''};
    if(fields[0]) snap.instructor=fields[0].value||'';
    if(fields[1]) snap.name=fields[1].value||'';
    if(fields[2]) snap.capacity=fields[2].value||'12';
    if(fields[3]) snap.room=fields[3].value||'';
    deletedStack.push(snap);
    updateUndoState();
    row.remove();
    if(!wkContainer.querySelector('.wkRow')) wkContainer.innerHTML='';
  });
  undoDeleteBtn.onclick=()=>{
    if(locked||deletedStack.length===0) return;
    const snap=deletedStack.pop();
    updateUndoState();
    ensureHeader();
    newRow(snap);
  };
  function updateUndoState(){
    undoDeleteBtn.disabled=locked||deletedStack.length===0;
  }
  clearWorkshops.onclick=()=>{
    if(locked) return;
    if(confirm('Clear all workshop rows?')){
      wkContainer.innerHTML='';
      deletedStack=[];
      updateUndoState();
    }
  };
  document.getElementById('resetAll')?.addEventListener('click',()=>{
    if(confirm('Reset workshops, students, and assignments?')){
      locked=false;
      workshopList=[];
      students=[];
      assignMap.clear();
      assignedRows=[];
      unplaced=[];
      deletedStack=[];
      wkContainer.innerHTML='';
      lockWorkshops.disabled=false;
      lockWorkshops.textContent='Lock workshops and continue';
      lockNote.classList.add('hidden');
      setWorkshopControlsEnabled(true);
      csvFile.disabled=true;
      studentDrop.classList.add('disabled');
      studentsPreview.classList.add('hidden');
      resultsCard.classList.add('hidden');
      enableRunIfReady();
      setRunSeed();
    }
  });
  lockWorkshops.onclick=()=>{
    if(locked) return;
    const rows=wkContainer.querySelectorAll('.wkRow');
    if(!rows.length){alert('Add at least one workshop.');return;}
    let arr=[];
    let hasBlank=false;
    rows.forEach(row=>{
      const fields=row.querySelectorAll('input');
      const inst=normalize(fields[0]?.value||'');
      const name=normalize(fields[1]?.value||'');
      const cap=parseInt(fields[2]?.value||'',10)||12;
      const room=normalize(fields[3]?.value||'');
      if(!inst||!name){hasBlank=true;return;}
      arr.push({instructor:inst,name,capacity:cap,room});
    });
    if(hasBlank){alert('Fill in Instructor and Workshop for each row.');return;}
    const dupMap=new Map();
    arr.forEach(w=>{
      const k=key(w.name);
      dupMap.set(k,(dupMap.get(k)||0)+1);
    });
    const dups=[]; dupMap.forEach((ct,k)=>{ if(ct>1){const orig=arr.find(w=>key(w.name)===k); if(orig)dups.push(orig.name);} });
    if(dups.length){alert('Duplicate workshops:\n'+dups.join(', ')+'\n\nFix or remove duplicates.');return;}
    workshopList=arr;
    locked=true;
    lockWorkshops.disabled=true;
    lockWorkshops.textContent='Locked';
    lockNote.classList.remove('hidden');
    setWorkshopControlsEnabled(false);
    csvFile.disabled=false;
    studentDrop.classList.remove('disabled');
    enableRunIfReady();
    setRunSeed();
  };
  function parseCsvText(txt){
    const lines=[];
    let i=0, len=txt.length;
    while(i<len){
      const line=[];
      while(i<len){
        let cell='';
        if(txt[i]==='"'){
          i++;
          while(i<len){
            if(txt[i]==='"'){
              if(i+1<len&&txt[i+1]==='"'){cell+='"';i+=2;}
              else{i++;break;}
            }else{cell+=txt[i++];}
          }
        }else{
          while(i<len&&txt[i]!==','&&txt[i]!=='\r'&&txt[i]!=='\n') cell+=txt[i++];
        }
        line.push(cell);
        if(i<len&&txt[i]===','){i++;}
        else break;
      }
      if(line.length||i<len) lines.push(line);
      while(i<len&&(txt[i]==='\r'||txt[i]==='\n')) i++;
    }
    return lines;
  }
  function handleWorkshopCsvFile(file){
    if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const rows=parseCsvText(reader.result);
        if(rows.length<2){alert('CSV has <2 rows');return;}
        const head=rows[0].map(c=>normalize(c.toLowerCase()));
        const iInst=head.findIndex(h=>h.includes('instructor'));
        const iName=head.findIndex(h=>h.includes('workshop'));
        const iCap =head.findIndex(h=>h.includes('capacity'));
        const iRoom=head.findIndex(h=>h.includes('room'));
        if(iName<0){alert('No Workshop column');return;}
        wkContainer.innerHTML='';
        ensureHeader();
        deletedStack=[]; updateUndoState();
        for(let r=1;r<rows.length;r++){
          const row=rows[r];
          const inst=row[iInst>=0?iInst:0]||'';
          const name=row[iName]||'';
          const cap =row[iCap>=0?iCap:2]||'12';
          const room=row[iRoom>=0?iRoom:3]||'';
          if(name.trim()) newRow({instructor:inst,name,capacity:cap,room});
        }
      }catch(err){alert('CSV parse error:\n'+err.message);}
    };
    reader.readAsText(file);
  }
  setDropHandlers({zone:workshopDrop,onFile:handleWorkshopCsvFile,input:workshopCsvFile});
  workshopCsvFile.onchange=()=>{ const f=workshopCsvFile.files?.[0]; if(f)handleWorkshopCsvFile(f); };
  importWorkshopsBtn.onclick=()=>{ workshopCsvFile.click(); };
  function handleStudentCsvFile(file){
    if(!file||!locked) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const rows=parseCsvText(reader.result);
        if(rows.length<2){alert('CSV has <2 rows');return;}
        const head=rows[0].map(c=>normalize(c.toLowerCase()));
        let lastIdx=head.findIndex(h=>h.includes('last'));
        let firstIdx=head.findIndex(h=>h.includes('first'));
        let schoolIdx=head.findIndex(h=>h.includes('school'));
        let c1Idx=head.findIndex(h=>h.includes('choice')&&h.includes('1'));
        let c2Idx=head.findIndex(h=>h.includes('choice')&&h.includes('2'));
        let c3Idx=head.findIndex(h=>h.includes('choice')&&h.includes('3'));
        const hasNames=(lastIdx>=0&&firstIdx>=0);
        const hasChoices=(c1Idx>=0&&c2Idx>=0&&c3Idx>=0);
        if(!hasNames||!hasChoices){
          const sIdx=head.findIndex(h=>h.includes('student')&&!h.includes('choice'));
          if(sIdx>=0){
            lastIdx=sIdx; firstIdx=-1; schoolIdx=-1;
            if(c1Idx<0) c1Idx=head.findIndex((h,i)=>i>sIdx&&h.includes('choice'));
            if(c2Idx<0) c2Idx=head.findIndex((h,i)=>i>c1Idx&&i!==c1Idx&&h.includes('choice'));
            if(c3Idx<0) c3Idx=head.findIndex((h,i)=>i>c2Idx&&i!==c2Idx&&i!==c1Idx&&h.includes('choice'));
          }
          if(c1Idx<0||c2Idx<0||c3Idx<0||lastIdx<0){alert('Need Last, First, School + Choice1,2,3 or Student + choices');return;}
        }
        if(schoolIdx<0) schoolIdx=head.findIndex(h=>h.includes('school'));
        students=[];
        for(let r=1;r<rows.length;r++){
          const row=rows[r];
          const last =normalize(row[lastIdx]||'');
          const first=firstIdx>=0?normalize(row[firstIdx]||''):'';
          const school=schoolIdx>=0?normalize(row[schoolIdx]||''):'';
          const c1=normalize(row[c1Idx]||'');
          const c2=normalize(row[c2Idx]||'');
          const c3=normalize(row[c3Idx]||'');
          if(!last&&!first) continue;
          const label=firstIdx>=0?`${last}, ${first}`:last;
          students.push({id:students.length,last,first,school,label,preferences:[c1,c2,c3]});
        }
        renderStudentsTable();
        studentsPreview.classList.remove('hidden');
        enableRunIfReady();
      }catch(err){alert('CSV parse error:\n'+err.message);}
    };
    reader.readAsText(file);
  }
  setDropHandlers({zone:studentDrop,onFile:handleStudentCsvFile,input:csvFile});
  csvFile.onchange=()=>{ const f=csvFile.files?.[0]; if(f)handleStudentCsvFile(f); };
  function renderStudentsTable(){
    studentsTableBody.innerHTML='';
    let hasIssue=false;
    students.forEach(s=>{
      const prefs=s.preferences||[];
      const issues=[];
      const unknownNames=[];
      const uniqueP=new Set();
      prefs.forEach((p,i)=>{
        if(!p){issues.push(`Missing choice ${i+1}`);}
        else{
          if(uniqueP.has(key(p))){if(!issues.some(x=>x.includes('Duplicate')))issues.push('Duplicate choices');}
          else uniqueP.add(key(p));
          if(findWorkshopIndexByName(p)===-1) unknownNames.push(p);
        }
      });
      if(unknownNames.length){issues.push('Unknown: '+unknownNames.join(', '));}
      const issueClass=issues.length?'row-issue':'';
      const tr=document.createElement('tr'); tr.className=issueClass;
      tr.innerHTML=`<td>${s.last||''}</td><td>${s.first||''}</td><td>${s.school||''}</td>
        <td>${prefs[0]||''}</td><td>${prefs[1]||''}</td><td>${prefs[2]||''}</td>
        <td class="issues">${issues.length?issues.map(x=>`<span class="issue-pill">${x}</span>`).join(''):'—'}</td>`;
      studentsTableBody.appendChild(tr);
      if(issues.length) hasIssue=true;
    });
    document.getElementById('issueLegend')?.classList.toggle('hidden',!hasIssue);
  }
  runBtn.onclick=()=>{
    if(!locked||!students.length) return;
    assignMap.clear();
    assignedRows=[];
    unplaced=[];
    const availability=workshopList.map(w=>w.capacity);
    const unassignedIds=new Set(students.map(s=>s.id));
    for(let pass=0;pass<3 && unassignedIds.size>0;pass++){
      const candidates=[...unassignedIds];
      shuffle(candidates,runSeed+'-pass'+pass);
      candidates.forEach(id=>{
        const s=students.find(x=>x.id===id); if(!s) return;
        const pref=s.preferences[pass]; if(!pref){return;}
        const idx=findWorkshopIndexByName(pref); if(idx===-1){return;}
        if(availability[idx]>0){
          assignMap.set(id,workshopList[idx].name);
          availability[idx]--;
          unassignedIds.delete(id);
        }
      });
    }
    students.forEach(s=>{
      const ws=assignMap.get(s.id);
      const room=ws?workshopList.find(w=>w.name===ws)?.room||'':'';
      if(ws){assignedRows.push({...s,workshop:ws,room});}
      else{
        let reason='No capacity in any choice';
        const hadBad=s.preferences.some(p=>p&&findWorkshopIndexByName(p)===-1);
        if(hadBad) reason='Unknown or duplicate choices';
        const missing=s.preferences.filter(Boolean).length<3;
        if(missing) reason='Missing choices';
        const firstGood=s.preferences.find(p=>p&&findWorkshopIndexByName(p)!==-1)||'—';
        unplaced.push({...s,firstChoice:firstGood,reason});
      }
    });
    renderResults();
    resultsCard.classList.remove('hidden');
  };
  function shuffle(arr,seed){
    let hash=0;
    for(let i=0;i<seed.length;i++){hash=((hash<<5)-hash)+seed.charCodeAt(i);hash|=0;}
    function rng(){hash=((hash*1103515245)+12345)|0;return(hash>>>0)/2**32;}
    for(let i=arr.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}
  }
  function renderResults(){
    kvStudents.textContent=students.length;
    kvWorkshops.textContent=workshopList.length;
    const totCap=workshopList.reduce((s,w)=>s+w.capacity,0);
    kvCapacity.textContent=totCap;
    kvUnplaced.textContent=unplaced.length;
    balanceTableBody.innerHTML='';
    const wsMap=new Map();
    assignedRows.forEach(r=>{
      if(!wsMap.has(r.workshop)) wsMap.set(r.workshop,[]);
      wsMap.get(r.workshop).push(r);
    });
    const sorted=workshopList.slice().sort((a,b)=>a.name.localeCompare(b.name));
    sorted.forEach(w=>{
      const list=wsMap.get(w.name)||[];
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${w.instructor}</td><td>${w.name}</td><td style="text-align:right">${w.capacity}</td><td style="text-align:right">${list.length}</td><td>${w.room||'—'}</td>`;
      balanceTableBody.appendChild(tr);
    });
    studentTableBody.innerHTML='';
    const sorted2=assignedRows.slice().sort((a,b)=>a.last.localeCompare(b.last)||a.first.localeCompare(b.first));
    sorted2.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.last||''}</td><td>${r.first||''}</td><td>${r.school||''}</td><td>${r.workshop}</td><td>${r.room||'—'}</td>`;
      studentTableBody.appendChild(tr);
    });
    rosterDoc.innerHTML='';
    sorted.forEach(w=>{
      const list=(wsMap.get(w.name)||[]).slice().sort((a,b)=>a.last.localeCompare(b.last)||a.first.localeCompare(b.first));
      const sec=document.createElement('div'); sec.className='roster-section';
      const hdr=`<div class="roster-header"><div class="ws-name">${w.name}</div><div class="instructor">${w.instructor}</div><div class="room">${w.room?'Room: '+w.room:''}</div><div class="count">${list.length} / ${w.capacity}</div></div>`;
      const grid=list.length?`<div class="name-grid">${list.map(s=>`<div class="name">${s.last}, ${s.first}</div>`).join('')}</div>`:'<div style="padding:10px;text-align:center;color:#9ca3af">No students assigned</div>';
      sec.innerHTML=hdr+grid;
      rosterDoc.appendChild(sec);
    });
    unplacedTableBody.innerHTML='';
    const sorted3=unplaced.slice().sort((a,b)=>a.last.localeCompare(b.last)||a.first.localeCompare(b.first));
    sorted3.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.last||''}</td><td>${r.first||''}</td><td>${r.school||''}</td><td>${r.firstChoice}</td><td>${r.reason}</td>`;
      unplacedTableBody.appendChild(tr);
    });
  }
  printStudentsBtn.onclick=()=>exportTablesAsPDF('Students',[ {id:'studentsTable',label:'Loaded Students'} ]);
  printSummaryBtn.onclick=()=>exportTablesAsPDF('Summary',[ {id:'balanceTable',label:'Workshop Summary'} ]);
  printAssignmentsBtn.onclick=()=>exportTablesAsPDF('Student Assignments',[ {id:'studentTable',label:'Assigned Students'} ]);
  printUnplacedBtn.onclick=()=>exportTablesAsPDF('Unplaced Students',[ {id:'unplacedTable',label:'Unplaced'} ]);
  printRostersBtn.onclick=()=>{
    const lib=window.html2pdf;
    if(!lib){alert('PDF library not loaded');return;}
    const host=document.createElement('div');
    host.style.cssText='position:fixed;top:0;left:0;z-index:-1;visibility:hidden;width:100%';
    document.body.appendChild(host);
    const container=document.createElement('div');
    container.style.cssText='width:7.5in;margin:0;padding:0';
    const sorted=workshopList.slice().sort((a,b)=>a.name.localeCompare(b.name));
    const wsMap=new Map();
    assignedRows.forEach(r=>{if(!wsMap.has(r.workshop))wsMap.set(r.workshop,[]);wsMap.get(r.workshop).push(r);});
    let html='<style>html,body{margin:0;padding:0}*{box-sizing:border-box}h1{font:600 16pt Inter,Arial,sans-serif;margin:0 0 10pt 0;color:#1f2430}h2{font:600 12pt Inter,Arial,sans-serif;margin:14pt 0 6pt 0;color:#461D7C}.pdf-page{break-inside:avoid}.pdf-page+.pdf-page{break-before:page}.name-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4pt 12pt;margin:6pt 0}.name{border-bottom:1px solid #e5e7eb;padding:2pt 0}</style><h1>Workshop Rosters</h1>';
    sorted.forEach(w=>{
      const list=(wsMap.get(w.name)||[]).slice().sort((a,b)=>a.last.localeCompare(b.last)||a.first.localeCompare(b.first));
      html+=`<div class="pdf-page"><h2>${w.name} <small>(${list.length}/${w.capacity})</small></h2>`;
      if(w.instructor) html+=`<div style="margin:0 0 4pt 0"><strong>Instructor:</strong> ${w.instructor}</div>`;
      if(w.room) html+=`<div style="margin:0 0 4pt 0"><strong>Room:</strong> ${w.room}</div>`;
      if(!list.length) html+=`<div style="color:#9ca3af">No students assigned</div>`;
      else html+=`<div class="name-grid">${list.map(s=>`<div class="name">${s.last}, ${s.first}</div>`).join('')}</div>`;
      html+=`</div>`;
    });
    container.innerHTML=html;
    host.appendChild(container);
    const opt={
      margin:[36,36,36,36],
      filename:'workshop_rosters.pdf',
      image:{type:'jpeg',quality:0.98},
      html2canvas:{scale:2,useCORS:true,letterRendering:true,scrollY:0,scrollX:0},
      jsPDF:{unit:'pt',format:'letter',orientation:'portrait'},
      pagebreak:{mode:['css']}
    };
    lib().set(opt).from(container).toPdf().get('pdf').then(pdf=>{window.open(pdf.output('bloburl'),'_blank');}).finally(()=>host.remove());
  };
  const esc=s=>(s==null?'':String(s)).replace(/"/g,'""');
  exportStudentsCsvBtn.onclick=()=>{
    const rows=[['Last','First','School','Choice1','Choice2','Choice3']];
    students.forEach(s=>rows.push([s.last||'',s.first||'',s.school||'',s.preferences[0]||'',s.preferences[1]||'',s.preferences[2]||'']));
    downloadCsv('students.csv',rows.map(r=>r.map(esc).map(c=>`"${c}"`).join(',')).join('\r\n'));
  };
  exportSummaryCsvBtn.onclick=()=>{
    const rows=[['Instructor','Workshop','Capacity','Assigned','Room']];
    const wsMap=new Map();
    assignedRows.forEach(r=>{if(!wsMap.has(r.workshop))wsMap.set(r.workshop,[]);wsMap.get(r.workshop).push(r);});
    const sorted=workshopList.slice().sort((a,b)=>a.name.localeCompare(b.name));
    sorted.forEach(w=>{
      const list=wsMap.get(w.name)||[];
      rows.push([w.instructor,w.name,String(w.capacity),String(list.length),w.room||'']);
    });
    downloadCsv('summary.csv',rows.map(r=>r.map(esc).map(c=>`"${c}"`).join(',')).join('\r\n'));
  };
  exportAssignmentsCsvBtn.onclick=()=>{
    const rows=[['Last','First','School','Workshop','Room']];
    const sorted=assignedRows.slice().sort((a,b)=>a.last.localeCompare(b.last)||a.first.localeCompare(b.first));
    sorted.forEach(r=>rows.push([r.last||'',r.first||'',r.school||'',r.workshop,r.room||'']));
    downloadCsv('assignments.csv',rows.map(r=>r.map(esc).map(c=>`"${c}"`).join(',')).join('\r\n'));
  };
  exportUnplacedCsvBtn.onclick=()=>{
    const rows=[['Last','First','School','FirstChoice','Reason']];
    const sorted=unplaced.slice().sort((a,b)=>a.last.localeCompare(b.last)||a.first.localeCompare(b.first));
    sorted.forEach(r=>rows.push([r.last||'',r.first||'',r.school||'',r.firstChoice,r.reason]));
    downloadCsv('unplaced.csv',rows.map(r=>r.map(esc).map(c=>`"${c}"`).join(',')).join('\r\n'));
  };
  exportRostersCsvBtn.onclick=()=>{
    const rows=[['Workshop','Instructor','Room','Count','Student','School']];
    const rosterMap=new Map();
    assignedRows.forEach(r=>{if(!rosterMap.has(r.workshop))rosterMap.set(r.workshop,[]);rosterMap.get(r.workshop).push(r);});
    const roSorted=workshopList.slice().sort((a,b)=>a.name.localeCompare(b.name));
    roSorted.forEach(w=>{
      const list=(rosterMap.get(w.name)||[]).slice().sort((a,b)=>a.last.localeCompare(b.last)||a.first.localeCompare(b.first));
      if(list.length===0){
        rows.push([w.name, w.instructor, w.room||'', '0', '', '']);
      }else{
        list.forEach((s)=> rows.push([w.name, w.instructor, w.room||'', String(list.length), `${s.last}, ${s.first}`, s.school||'']));
      }
    });
    downloadCsv('rosters.csv',rows.map(r=>r.map(esc).map(c=>`"${c}"`).join(',')).join('\r\n'));
  };
  function downloadCsv(filename,csvText){
    const blob=new Blob([csvText],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  function exportToPDF(title, html) {
    const lib = window.html2pdf;
    if(!lib){ alert('PDF library did not load. Try again or check your network.'); return; }
    const host = document.createElement('div');
    host.style.position='fixed'; host.style.top='0'; host.style.left='0';
    host.style.zIndex='-1'; host.style.visibility='hidden'; host.style.width='100%';
    document.body.appendChild(host);
    const pdfStyles = `
      html, body { margin:0; padding:0; }
      * { box-sizing: border-box; }
      h1 { font: 600 16pt Inter, Arial, sans-serif; margin: 0 0 10pt 0; color:#1f2430; }
      h2 { font: 600 12pt Inter, Arial, sans-serif; margin: 14pt 0 6pt 0; color:#461D7C; }
      h2 small { font-weight:400; color:#6b7280; }
      .pdf-page{ break-inside: avoid; }
      .pdf-page + .pdf-page{ break-before: page; }
      table { width:100%; }
      table.report {
        border-collapse: separate; border-spacing: 0; border: 1px solid #d1d5db; border-radius: 10px; background: #fff;
      }
      thead { display: table-header-group; }
      .report thead th { background:#f8fafc; font-weight:600; }
      .report th, .report td {
        border-right:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; padding:7pt 8pt; line-height:1.25; vertical-align: top; text-align: left;
      }
      .report th:last-child, .report td:last-child { border-right:0 }
      .report tr:last-child td { border-bottom:0 }
      .summary-table th:nth-child(3), .summary-table td:nth-child(3),
      .summary-table th:nth-child(4), .summary-table td:nth-child(4){ text-align:right; font-variant-numeric:tabular-nums; }
      .summary-table th:nth-child(5), .summary-table td:nth-child(5){ white-space:nowrap; }
    `;
    const container = document.createElement('div');
    container.style.width = '7.5in'; container.style.margin = '0'; container.style.padding = '0';
    container.innerHTML = `<style>${pdfStyles}</style><h1>${title}</h1>${html}`;
    host.appendChild(container);
    const opt = {
      margin: [36, 36, 36, 36],
      filename: `${title.toLowerCase().replace(/\s+/g, '_')}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, letterRendering: true, scrollY: 0, scrollX: 0 },
      jsPDF: { unit: 'pt', format: 'letter', orientation: 'portrait' },
      pagebreak: { mode: ['css'] }
    };
    lib().set(opt).from(container).toPdf().get('pdf').then(pdf=>{
      const url = pdf.output('bloburl'); window.open(url, '_blank');
    }).finally(()=>host.remove());
  }
  function exportTablesAsPDF(title, items){
    let html = "";
    items.forEach(({id, label})=>{
      const t=document.getElementById(id);
      if(!t) return;
      html += `<h2>${label}</h2><table class="report">${t.tHead.outerHTML}${t.tBodies[0].outerHTML}</table>`;
    });
    exportToPDF(title, html);
  }
  function setTab(which) {
    [tabSummary, tabStudents, tabRosters, tabUnplaced].forEach(t => t.classList.remove('active'));
    [panelSummary, panelStudents, panelRosters, panelUnplaced].forEach(p => p.classList.add('hidden'));
    if (which === 'summary') {tabSummary.classList.add('active'); panelSummary.classList.remove('hidden')}
    if (which === 'students') {tabStudents.classList.add('active'); panelStudents.classList.remove('hidden')}
    if (which === 'rosters') {tabRosters.classList.add('active'); panelRosters.classList.remove('hidden')}
    if (which === 'unplaced') {tabUnplaced.classList.add('active'); panelUnplaced.classList.remove('hidden')}
  }
  tabSummary.onclick = () => setTab('summary');
  tabStudents.onclick = () => setTab('students');
  tabRosters.onclick = () => setTab('rosters');
  tabUnplaced.onclick = () => setTab('unplaced');
}catch(err){
  console.error(err);
  showInitError(err && err.message ? err.message : String(err));
}
</script>
</body>
</html>
